name: Pre-Publish Check

on:
  workflow_dispatch:
    inputs:
      packages:
        description: 'Packages to check (comma-separated, e.g., core,semantic,i18n or "all")'
        required: true
        type: string
        default: 'all'

jobs:
  pre-publish-check:
    name: Validate Publication Readiness
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Parse package list
        id: packages
        run: |
          PACKAGES="${{ github.event.inputs.packages }}"
          if [ "$PACKAGES" = "all" ]; then
            PACKAGES="framework,semantic,core,i18n,hyperscript-adapter,patterns-reference,server-bridge,types-browser,domain-sql,domain-bdd,domain-llm,domain-todo,domain-behaviorspec,domain-jsx,domain-flow,aot-compiler,compilation-service,mcp-server,vite-plugin,behaviors,testing-framework,language-server,mcp-server-hyperscript,language-server-hyperscript,multilingual-hyperscript"
          fi
          echo "Checking packages: $PACKAGES"
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT

      - name: Check versions
        id: versions
        run: |
          echo "## Package Versions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|--------|" >> $GITHUB_STEP_SUMMARY

          IFS=',' read -ra PKG_ARRAY <<< "${{ steps.packages.outputs.packages }}"
          for pkg in "${PKG_ARRAY[@]}"; do
            pkg=$(echo "$pkg" | xargs)
            if [ -f "packages/$pkg/package.json" ]; then
              VERSION=$(node -p "require('./packages/$pkg/package.json').version")
              PRIVATE=$(node -p "require('./packages/$pkg/package.json').private || false")

              if [ "$PRIVATE" = "true" ]; then
                echo "| $(node -p "require('./packages/$pkg/package.json').name" 2>/dev/null || echo "$pkg") | $VERSION | âš ï¸ Private |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $(node -p "require('./packages/$pkg/package.json').name" 2>/dev/null || echo "$pkg") | $VERSION | âœ… Public |" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "| $(node -p "require('./packages/$pkg/package.json').name" 2>/dev/null || echo "$pkg") | N/A | âŒ Not found |" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Check required files
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Required Files Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | README | CHANGELOG | LICENSE | package.json |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-----------|---------|--------------|" >> $GITHUB_STEP_SUMMARY

          IFS=',' read -ra PKG_ARRAY <<< "${{ steps.packages.outputs.packages }}"
          for pkg in "${PKG_ARRAY[@]}"; do
            pkg=$(echo "$pkg" | xargs)
            if [ -d "packages/$pkg" ]; then
              README="âŒ"
              CHANGELOG="âŒ"
              LICENSE="âŒ"
              PACKAGE="âŒ"

              [ -f "packages/$pkg/README.md" ] && README="âœ…"
              [ -f "packages/$pkg/CHANGELOG.md" ] && CHANGELOG="âœ…"
              [ -f "packages/$pkg/LICENSE" ] || [ -f "LICENSE" ] && LICENSE="âœ…"
              [ -f "packages/$pkg/package.json" ] && PACKAGE="âœ…"

              echo "| $(node -p "require('./packages/$pkg/package.json').name" 2>/dev/null || echo "$pkg") | $README | $CHANGELOG | $LICENSE | $PACKAGE |" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Build dependencies first
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Building core packages (required for typecheck)..." >> $GITHUB_STEP_SUMMARY

          # Build in dependency order (matches ci.yml and publish.yml)
          BUILD_ORDER="framework domain-bdd domain-sql domain-jsx domain-todo domain-behaviorspec domain-llm domain-flow semantic core patterns-reference i18n hyperscript-adapter ast-toolkit aot-compiler compilation-service mcp-server server-bridge types-browser vite-plugin language-server"

          for pkg in $BUILD_ORDER; do
            if [ -d "packages/$pkg" ]; then
              PKG_NAME=$(node -p "require('./packages/$pkg/package.json').name" 2>/dev/null || echo "$pkg")
              echo "Building $PKG_NAME..."
              npm run build --prefix "packages/$pkg" 2>&1 || echo "  âš  build failed for $pkg"
            fi
          done

          # Browser bundles (requires i18n/dist)
          if [ -d "packages/core" ]; then
            npm run build:browser --prefix packages/core 2>&1 || echo "  âš  browser build failed"
          fi

          echo "âœ… Dependency builds complete" >> $GITHUB_STEP_SUMMARY

      - name: TypeCheck
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## TypeScript Compilation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          IFS=',' read -ra PKG_ARRAY <<< "${{ steps.packages.outputs.packages }}"
          for pkg in "${PKG_ARRAY[@]}"; do
            pkg=$(echo "$pkg" | xargs)
            if [ -d "packages/$pkg" ] && [ -f "packages/$pkg/tsconfig.json" ]; then
              echo "Checking $(node -p "require('./packages/$pkg/package.json').name")..."
              if npm run typecheck --prefix "packages/$pkg" 2>&1 | tee /tmp/${pkg}-typecheck.log; then
                echo "âœ… $(node -p "require('./packages/$pkg/package.json').name" 2>/dev/null || echo "$pkg") - TypeScript OK" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ $(node -p "require('./packages/$pkg/package.json').name" 2>/dev/null || echo "$pkg") - TypeScript errors found" >> $GITHUB_STEP_SUMMARY
                echo "<details><summary>Errors</summary>" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                cat /tmp/${pkg}-typecheck.log >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                echo "</details>" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: Run tests
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          IFS=',' read -ra PKG_ARRAY <<< "${{ steps.packages.outputs.packages }}"
          for pkg in "${PKG_ARRAY[@]}"; do
            pkg=$(echo "$pkg" | xargs)
            if [ -d "packages/$pkg" ] && [ -f "packages/$pkg/package.json" ]; then
              if grep -q '"test"' "packages/$pkg/package.json"; then
                echo "Testing $(node -p "require('./packages/$pkg/package.json').name")..."
                if npm test --prefix "packages/$pkg" 2>&1 | tee /tmp/${pkg}-test.log; then
                  TESTS=$(grep -o '[0-9]* passed' /tmp/${pkg}-test.log | head -1 || echo "0 passed")
                  echo "âœ… $(node -p "require('./packages/$pkg/package.json').name" 2>/dev/null || echo "$pkg") - $TESTS" >> $GITHUB_STEP_SUMMARY
                else
                  echo "âŒ $(node -p "require('./packages/$pkg/package.json').name" 2>/dev/null || echo "$pkg") - Tests failed" >> $GITHUB_STEP_SUMMARY
                fi
              else
                echo "âš ï¸ $(node -p "require('./packages/$pkg/package.json').name" 2>/dev/null || echo "$pkg") - No tests configured" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: Build check
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          IFS=',' read -ra PKG_ARRAY <<< "${{ steps.packages.outputs.packages }}"
          for pkg in "${PKG_ARRAY[@]}"; do
            pkg=$(echo "$pkg" | xargs)
            if [ -d "packages/$pkg" ] && [ -f "packages/$pkg/package.json" ]; then
              if grep -q '"build"' "packages/$pkg/package.json"; then
                echo "Building $(node -p "require('./packages/$pkg/package.json').name" 2>/dev/null || echo "$pkg")..."
                if npm run build --prefix "packages/$pkg" 2>&1 | tee /tmp/${pkg}-build.log; then
                  # Check dist directory
                  if [ -d "packages/$pkg/dist" ] && [ "$(ls -A packages/$pkg/dist)" ]; then
                    FILES=$(ls packages/$pkg/dist | wc -l)
                    echo "âœ… $(node -p "require('./packages/$pkg/package.json').name" 2>/dev/null || echo "$pkg") - Built successfully ($FILES files)" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "âš ï¸ $(node -p "require('./packages/$pkg/package.json').name" 2>/dev/null || echo "$pkg") - Built but dist is empty" >> $GITHUB_STEP_SUMMARY
                  fi
                else
                  echo "âŒ $(node -p "require('./packages/$pkg/package.json').name" 2>/dev/null || echo "$pkg") - Build failed" >> $GITHUB_STEP_SUMMARY
                fi
              else
                echo "âš ï¸ $(node -p "require('./packages/$pkg/package.json').name" 2>/dev/null || echo "$pkg") - No build script" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: Validate exports
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Export Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Verifying all package.json exports resolve to actual files..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          IFS=',' read -ra PKG_ARRAY <<< "${{ steps.packages.outputs.packages }}"
          FAILED_PKGS=""

          for pkg in "${PKG_ARRAY[@]}"; do
            pkg=$(echo "$pkg" | xargs)
            if [ -d "packages/$pkg" ] && [ -f "packages/$pkg/package.json" ]; then
              echo "Validating $(node -p "require('./packages/$pkg/package.json').name") exports..."
              if node scripts/validate-exports.mjs "$pkg" 2>&1 | tee /tmp/${pkg}-exports.log; then
                MISSING=$(grep -c "Missing exports" /tmp/${pkg}-exports.log 2>/dev/null || echo "0")
                if [ "$MISSING" = "0" ]; then
                  echo "âœ… $(node -p "require('./packages/$pkg/package.json').name" 2>/dev/null || echo "$pkg") - All exports valid" >> $GITHUB_STEP_SUMMARY
                else
                  echo "âŒ $(node -p "require('./packages/$pkg/package.json').name" 2>/dev/null || echo "$pkg") - Missing exports detected" >> $GITHUB_STEP_SUMMARY
                  FAILED_PKGS="$FAILED_PKGS $pkg"
                fi
              else
                echo "âŒ $(node -p "require('./packages/$pkg/package.json').name" 2>/dev/null || echo "$pkg") - Export validation failed" >> $GITHUB_STEP_SUMMARY
                FAILED_PKGS="$FAILED_PKGS $pkg"
              fi
            fi
          done

          if [ -n "$FAILED_PKGS" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Export validation issues found in:**$FAILED_PKGS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run \`node scripts/validate-exports.mjs --fix-suggestions\` locally for details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Package.json validation
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## package.json Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | name | version | main | types | license | publishConfig |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|---------|------|-------|---------|---------------|" >> $GITHUB_STEP_SUMMARY

          IFS=',' read -ra PKG_ARRAY <<< "${{ steps.packages.outputs.packages }}"
          for pkg in "${PKG_ARRAY[@]}"; do
            pkg=$(echo "$pkg" | xargs)
            if [ -f "packages/$pkg/package.json" ]; then
              NAME=$(node -p "require('./packages/$pkg/package.json').name || 'âŒ'" 2>/dev/null)
              VERSION=$(node -p "require('./packages/$pkg/package.json').version || 'âŒ'" 2>/dev/null)
              MAIN=$(node -p "require('./packages/$pkg/package.json').main ? 'âœ…' : 'âŒ'" 2>/dev/null)
              TYPES=$(node -p "require('./packages/$pkg/package.json').types ? 'âœ…' : 'âŒ'" 2>/dev/null)
              LICENSE=$(node -p "require('./packages/$pkg/package.json').license || 'âŒ'" 2>/dev/null)
              PUB_CONFIG=$(node -p "require('./packages/$pkg/package.json').publishConfig?.access || 'âŒ'" 2>/dev/null)

              echo "| $pkg | $NAME | $VERSION | $MAIN | $TYPES | $LICENSE | $PUB_CONFIG |" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Build browser bundles
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Browser Bundle Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "packages/core" ]; then
            echo "Building all browser bundles..."
            if npm run build:browser --prefix packages/core 2>&1 | tee /tmp/bundle-build.log; then
              echo "âœ… All browser bundles built successfully" >> $GITHUB_STEP_SUMMARY

              # List built bundles with sizes
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Bundle Sizes" >> $GITHUB_STEP_SUMMARY
              echo "| Bundle | Size | Gzipped |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|------|---------|" >> $GITHUB_STEP_SUMMARY

              for file in packages/core/dist/hyperfixi*.js packages/core/dist/lokascript-*.js; do
                if [[ -f "$file" && ! "$file" == *.map ]]; then
                  filename=$(basename "$file")
                  size=$(wc -c < "$file" | tr -d ' ')
                  gzip_size=$(gzip -c "$file" | wc -c | tr -d ' ')
                  size_kb=$((size / 1024))
                  gzip_kb=$((gzip_size / 1024))
                  echo "| $filename | ${size_kb} KB | ${gzip_kb} KB |" >> $GITHUB_STEP_SUMMARY
                fi
              done
            else
              echo "âŒ Bundle build failed" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          fi

      - name: Bundle size limit checks
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Bundle Size Limit Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Size limits (gzipped bytes)
          MAX_LITE=4000           # 4 KB
          MAX_HYBRID=15000        # 15 KB
          MAX_BROWSER=230000      # 230 KB

          failed=0

          # Check lite bundle
          if [[ -f "packages/core/dist/hyperfixi-lite.js" ]]; then
            size=$(gzip -c packages/core/dist/hyperfixi-lite.js | wc -c | tr -d ' ')
            if [[ "$size" -gt "$MAX_LITE" ]]; then
              echo "âŒ hyperfixi-lite.js (${size} bytes gzip) exceeds limit (${MAX_LITE} bytes)" >> $GITHUB_STEP_SUMMARY
              failed=1
            else
              echo "âœ… hyperfixi-lite.js (${size} bytes gzip) within limit (${MAX_LITE} bytes)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Check hybrid bundles
          for bundle in packages/core/dist/hyperfixi-hybrid-*.js; do
            if [[ -f "$bundle" ]]; then
              size=$(gzip -c "$bundle" | wc -c | tr -d ' ')
              filename=$(basename "$bundle")
              if [[ "$size" -gt "$MAX_HYBRID" ]]; then
                echo "âŒ $filename (${size} bytes gzip) exceeds limit (${MAX_HYBRID} bytes)" >> $GITHUB_STEP_SUMMARY
                failed=1
              else
                echo "âœ… $filename (${size} bytes gzip) within limit (${MAX_HYBRID} bytes)" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

          # Check full browser bundle
          if [[ -f "packages/core/dist/hyperfixi.js" ]]; then
            size=$(gzip -c packages/core/dist/hyperfixi.js | wc -c | tr -d ' ')
            if [[ "$size" -gt "$MAX_BROWSER" ]]; then
              echo "âŒ hyperfixi.js (${size} bytes gzip) exceeds limit (${MAX_BROWSER} bytes)" >> $GITHUB_STEP_SUMMARY
              failed=1
            else
              echo "âœ… hyperfixi.js (${size} bytes gzip) within limit (${MAX_BROWSER} bytes)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          if [[ $failed -eq 1 ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Bundle size limit violations detected. Review bundle sizes before publishing.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Install Playwright
        run: npx playwright install chromium --with-deps

      - name: Start HTTP server
        run: |
          cd packages/core
          npx http-server ../.. -p 3000 -c-1 &
          echo $! > /tmp/http-server.pid
          sleep 3
          echo "HTTP server started on port 3000"

      - name: Bundle Compatibility Matrix
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Bundle Compatibility Matrix" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          cd packages/core

          if npx playwright test src/compatibility/browser-tests/bundle-compatibility.spec.ts --reporter=list 2>&1 | tee /tmp/bundle-compat.log; then
            echo "âœ… All bundle compatibility tests passed" >> $GITHUB_STEP_SUMMARY

            # Extract and display the ASCII matrix from test output
            if grep -A 30 "HYPERFIXI BUNDLE COMPATIBILITY MATRIX" /tmp/bundle-compat.log > /tmp/matrix.txt; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "<details><summary>Bundle Feature Matrix</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              cat /tmp/matrix.txt >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Bundle compatibility tests failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Test Failures</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -100 /tmp/bundle-compat.log >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Stop HTTP server
        if: always()
        run: |
          if [ -f /tmp/http-server.pid ]; then
            kill $(cat /tmp/http-server.pid) || true
          fi

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bundle-compatibility-report
          path: packages/core/playwright-report/
          retention-days: 7

      - name: Final verdict
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Publication Readiness Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the checks above. All items should show âœ… for publication." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If all checks pass, proceed to the \`Publish Packages\` workflow." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Review all âŒ and âš ï¸ items above" >> $GITHUB_STEP_SUMMARY
          echo "2. Fix any issues" >> $GITHUB_STEP_SUMMARY
          echo "3. Run this check again" >> $GITHUB_STEP_SUMMARY
          echo "4. When all green, use \`Publish Packages\` workflow" >> $GITHUB_STEP_SUMMARY
