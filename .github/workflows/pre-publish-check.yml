name: Pre-Publish Check

on:
  workflow_dispatch:
    inputs:
      packages:
        description: 'Packages to check (comma-separated, e.g., core,semantic,i18n or "all")'
        required: true
        type: string
        default: 'core,semantic,i18n,vite-plugin,mcp-server'

jobs:
  pre-publish-check:
    name: Validate Publication Readiness
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Parse package list
        id: packages
        run: |
          PACKAGES="${{ github.event.inputs.packages }}"
          if [ "$PACKAGES" = "all" ]; then
            PACKAGES="core,semantic,i18n,vite-plugin,mcp-server,ast-toolkit,behaviors,multi-tenant"
          fi
          echo "Checking packages: $PACKAGES"
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT

      - name: Check versions
        id: versions
        run: |
          echo "## Package Versions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|--------|" >> $GITHUB_STEP_SUMMARY

          IFS=',' read -ra PKG_ARRAY <<< "${{ steps.packages.outputs.packages }}"
          for pkg in "${PKG_ARRAY[@]}"; do
            pkg=$(echo "$pkg" | xargs)
            if [ -f "packages/$pkg/package.json" ]; then
              VERSION=$(node -p "require('./packages/$pkg/package.json').version")
              PRIVATE=$(node -p "require('./packages/$pkg/package.json').private || false")

              if [ "$PRIVATE" = "true" ]; then
                echo "| @lokascript/$pkg | $VERSION | âš ï¸ Private |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| @lokascript/$pkg | $VERSION | âœ… Public |" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "| @lokascript/$pkg | N/A | âŒ Not found |" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Check required files
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Required Files Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | README | CHANGELOG | LICENSE | package.json |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-----------|---------|--------------|" >> $GITHUB_STEP_SUMMARY

          IFS=',' read -ra PKG_ARRAY <<< "${{ steps.packages.outputs.packages }}"
          for pkg in "${PKG_ARRAY[@]}"; do
            pkg=$(echo "$pkg" | xargs)
            if [ -d "packages/$pkg" ]; then
              README="âŒ"
              CHANGELOG="âŒ"
              LICENSE="âŒ"
              PACKAGE="âŒ"

              [ -f "packages/$pkg/README.md" ] && README="âœ…"
              [ -f "packages/$pkg/CHANGELOG.md" ] && CHANGELOG="âœ…"
              [ -f "packages/$pkg/LICENSE" ] || [ -f "LICENSE" ] && LICENSE="âœ…"
              [ -f "packages/$pkg/package.json" ] && PACKAGE="âœ…"

              echo "| @lokascript/$pkg | $README | $CHANGELOG | $LICENSE | $PACKAGE |" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Build dependencies first
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Building core packages (required for typecheck)..." >> $GITHUB_STEP_SUMMARY

          # Build in dependency order:
          # 1. patterns-reference (no deps)
          # 2. ast-toolkit (depends on patterns-reference)
          # 3. semantic (no lokascript deps)
          # 4. core (depends on semantic, patterns-reference)
          # 5. i18n (depends on ast-toolkit)

          if [ -d "packages/patterns-reference" ]; then
            echo "Building @lokascript/patterns-reference..."
            npm run build --prefix packages/patterns-reference 2>&1 || true
          fi

          if [ -d "packages/ast-toolkit" ]; then
            echo "Building @lokascript/ast-toolkit..."
            npm run build --prefix packages/ast-toolkit 2>&1 || true
          fi

          if [ -d "packages/semantic" ]; then
            echo "Building @lokascript/semantic..."
            npm run build --prefix packages/semantic 2>&1 || true
          fi

          if [ -d "packages/core" ]; then
            echo "Building @lokascript/core..."
            npm run build --prefix packages/core 2>&1 || true
            npm run build:parser-modules --prefix packages/core 2>&1 || true
          fi

          if [ -d "packages/i18n" ]; then
            echo "Building @lokascript/i18n..."
            npm run build --prefix packages/i18n 2>&1 || true
          fi

          echo "âœ… Dependency builds complete" >> $GITHUB_STEP_SUMMARY

      - name: TypeCheck
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## TypeScript Compilation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          IFS=',' read -ra PKG_ARRAY <<< "${{ steps.packages.outputs.packages }}"
          for pkg in "${PKG_ARRAY[@]}"; do
            pkg=$(echo "$pkg" | xargs)
            if [ -d "packages/$pkg" ] && [ -f "packages/$pkg/tsconfig.json" ]; then
              echo "Checking @lokascript/$pkg..."
              if npm run typecheck --prefix "packages/$pkg" 2>&1 | tee /tmp/${pkg}-typecheck.log; then
                echo "âœ… @lokascript/$pkg - TypeScript OK" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ @lokascript/$pkg - TypeScript errors found" >> $GITHUB_STEP_SUMMARY
                echo "<details><summary>Errors</summary>" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                cat /tmp/${pkg}-typecheck.log >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                echo "</details>" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: Run tests
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          IFS=',' read -ra PKG_ARRAY <<< "${{ steps.packages.outputs.packages }}"
          for pkg in "${PKG_ARRAY[@]}"; do
            pkg=$(echo "$pkg" | xargs)
            if [ -d "packages/$pkg" ] && [ -f "packages/$pkg/package.json" ]; then
              if grep -q '"test"' "packages/$pkg/package.json"; then
                echo "Testing @lokascript/$pkg..."
                if npm test --prefix "packages/$pkg" -- --run 2>&1 | tee /tmp/${pkg}-test.log; then
                  TESTS=$(grep -o '[0-9]* passed' /tmp/${pkg}-test.log | head -1 || echo "0 passed")
                  echo "âœ… @lokascript/$pkg - $TESTS" >> $GITHUB_STEP_SUMMARY
                else
                  echo "âŒ @lokascript/$pkg - Tests failed" >> $GITHUB_STEP_SUMMARY
                fi
              else
                echo "âš ï¸ @lokascript/$pkg - No tests configured" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: Build check
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          IFS=',' read -ra PKG_ARRAY <<< "${{ steps.packages.outputs.packages }}"
          for pkg in "${PKG_ARRAY[@]}"; do
            pkg=$(echo "$pkg" | xargs)
            if [ -d "packages/$pkg" ] && [ -f "packages/$pkg/package.json" ]; then
              if grep -q '"build"' "packages/$pkg/package.json"; then
                echo "Building @lokascript/$pkg..."
                if npm run build --prefix "packages/$pkg" 2>&1 | tee /tmp/${pkg}-build.log; then
                  # Check dist directory
                  if [ -d "packages/$pkg/dist" ] && [ "$(ls -A packages/$pkg/dist)" ]; then
                    FILES=$(ls packages/$pkg/dist | wc -l)
                    echo "âœ… @lokascript/$pkg - Built successfully ($FILES files)" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "âš ï¸ @lokascript/$pkg - Built but dist is empty" >> $GITHUB_STEP_SUMMARY
                  fi
                else
                  echo "âŒ @lokascript/$pkg - Build failed" >> $GITHUB_STEP_SUMMARY
                fi
              else
                echo "âš ï¸ @lokascript/$pkg - No build script" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: Validate exports
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Export Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Verifying all package.json exports resolve to actual files..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          IFS=',' read -ra PKG_ARRAY <<< "${{ steps.packages.outputs.packages }}"
          FAILED_PKGS=""

          for pkg in "${PKG_ARRAY[@]}"; do
            pkg=$(echo "$pkg" | xargs)
            if [ -d "packages/$pkg" ] && [ -f "packages/$pkg/package.json" ]; then
              echo "Validating @lokascript/$pkg exports..."
              if node scripts/validate-exports.mjs "$pkg" 2>&1 | tee /tmp/${pkg}-exports.log; then
                MISSING=$(grep -c "Missing exports" /tmp/${pkg}-exports.log 2>/dev/null || echo "0")
                if [ "$MISSING" = "0" ]; then
                  echo "âœ… @lokascript/$pkg - All exports valid" >> $GITHUB_STEP_SUMMARY
                else
                  echo "âŒ @lokascript/$pkg - Missing exports detected" >> $GITHUB_STEP_SUMMARY
                  FAILED_PKGS="$FAILED_PKGS $pkg"
                fi
              else
                echo "âŒ @lokascript/$pkg - Export validation failed" >> $GITHUB_STEP_SUMMARY
                FAILED_PKGS="$FAILED_PKGS $pkg"
              fi
            fi
          done

          if [ -n "$FAILED_PKGS" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Export validation issues found in:**$FAILED_PKGS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run \`node scripts/validate-exports.mjs --fix-suggestions\` locally for details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Package.json validation
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## package.json Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | name | version | main | types | license | publishConfig |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|---------|------|-------|---------|---------------|" >> $GITHUB_STEP_SUMMARY

          IFS=',' read -ra PKG_ARRAY <<< "${{ steps.packages.outputs.packages }}"
          for pkg in "${PKG_ARRAY[@]}"; do
            pkg=$(echo "$pkg" | xargs)
            if [ -f "packages/$pkg/package.json" ]; then
              NAME=$(node -p "require('./packages/$pkg/package.json').name || 'âŒ'" 2>/dev/null)
              VERSION=$(node -p "require('./packages/$pkg/package.json').version || 'âŒ'" 2>/dev/null)
              MAIN=$(node -p "require('./packages/$pkg/package.json').main ? 'âœ…' : 'âŒ'" 2>/dev/null)
              TYPES=$(node -p "require('./packages/$pkg/package.json').types ? 'âœ…' : 'âŒ'" 2>/dev/null)
              LICENSE=$(node -p "require('./packages/$pkg/package.json').license || 'âŒ'" 2>/dev/null)
              PUB_CONFIG=$(node -p "require('./packages/$pkg/package.json').publishConfig?.access || 'âŒ'" 2>/dev/null)

              echo "| $pkg | $NAME | $VERSION | $MAIN | $TYPES | $LICENSE | $PUB_CONFIG |" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Final verdict
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Publication Readiness Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the checks above. All items should show âœ… for publication." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If all checks pass, proceed to the \`Publish Packages\` workflow." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Review all âŒ and âš ï¸ items above" >> $GITHUB_STEP_SUMMARY
          echo "2. Fix any issues" >> $GITHUB_STEP_SUMMARY
          echo "3. Run this check again" >> $GITHUB_STEP_SUMMARY
          echo "4. When all green, use \`Publish Packages\` workflow" >> $GITHUB_STEP_SUMMARY
