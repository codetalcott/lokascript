name: Performance Benchmarks

on:
  push:
    branches: [main]
    paths:
      - 'packages/core/src/**'
      - 'packages/semantic/src/**'
      - 'packages/core/bench/**'
      - '.github/workflows/benchmark.yml'
  pull_request:
    paths:
      - 'packages/core/src/**'
      - 'packages/semantic/src/**'
      - 'packages/core/bench/**'
      - '.github/workflows/benchmark.yml'
  workflow_dispatch:
    inputs:
      baseline_update:
        description: 'Update baseline'
        type: boolean
        default: false

jobs:
  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: |
          npm run build --prefix packages/semantic
          npm run build:browser --prefix packages/core

      - name: Run benchmarks
        run: npm run bench:run --prefix packages/core
        continue-on-error: true

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: packages/core/benchmark-results/
          retention-days: 30

  bundle-analysis:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build all bundles
        run: |
          npm run build --prefix packages/semantic
          npm run build --prefix packages/i18n
          npm run build:browser --prefix packages/core

      - name: Run bundle size analysis
        run: node scripts/benchmark/bundle-size-check.mjs

      - name: Generate size report
        run: |
          echo "## Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Core Bundles" >> $GITHUB_STEP_SUMMARY
          echo "| Bundle | Raw | Gzipped |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----|---------|" >> $GITHUB_STEP_SUMMARY

          for file in packages/core/dist/lokascript-*.js; do
            if [[ -f "$file" && ! "$file" == *.map ]]; then
              filename=$(basename "$file")
              raw=$(wc -c < "$file" | tr -d ' ')
              gzip=$(gzip -c "$file" | wc -c | tr -d ' ')
              raw_kb=$(echo "scale=1; $raw / 1024" | bc)
              gzip_kb=$(echo "scale=1; $gzip / 1024" | bc)
              echo "| $filename | ${raw_kb} KB | ${gzip_kb} KB |" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Check size limits
        run: |
          # Size limits (gzipped bytes)
          MAX_LITE=4000           # 4 KB
          MAX_HYBRID=15000        # 15 KB
          MAX_BROWSER=230000      # 230 KB (actual: ~203-208 KB, allow headroom)

          failed=0

          if [[ -f "packages/core/dist/lokascript-lite.js" ]]; then
            size=$(gzip -c packages/core/dist/lokascript-lite.js | wc -c | tr -d ' ')
            if [[ "$size" -gt "$MAX_LITE" ]]; then
              echo "::error::lokascript-lite.js ($size bytes gzip) exceeds limit ($MAX_LITE bytes)"
              failed=1
            fi
          fi

          if [[ -f "packages/core/dist/lokascript-hybrid-complete.js" ]]; then
            size=$(gzip -c packages/core/dist/lokascript-hybrid-complete.js | wc -c | tr -d ' ')
            if [[ "$size" -gt "$MAX_HYBRID" ]]; then
              echo "::error::lokascript-hybrid-complete.js ($size bytes gzip) exceeds limit ($MAX_HYBRID bytes)"
              failed=1
            fi
          fi

          if [[ -f "packages/core/dist/lokascript-browser.js" ]]; then
            size=$(gzip -c packages/core/dist/lokascript-browser.js | wc -c | tr -d ' ')
            if [[ "$size" -gt "$MAX_BROWSER" ]]; then
              echo "::error::lokascript-browser.js ($size bytes gzip) exceeds limit ($MAX_BROWSER bytes)"
              failed=1
            fi
          fi

          exit $failed
