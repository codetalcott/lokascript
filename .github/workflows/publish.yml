name: Publish Packages

on:
  workflow_dispatch:
    inputs:
      version-type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - prerelease
        default: 'patch'
      npm-tag:
        description: 'npm dist-tag (latest, beta, next, etc.)'
        required: true
        type: string
        default: 'latest'
      dry-run:
        description: 'Dry run (do not actually publish)'
        required: false
        type: boolean
        default: false

env:
  NODE_OPTIONS: --max-old-space-size=4096
  # All public packages to publish (in dependency order)
  PACKAGES: 'semantic,core,i18n,hyperscript-adapter,patterns-reference,mcp-server,vite-plugin'

jobs:
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: npm install --prefer-offline

      - name: Build packages
        run: |
          # Build order based on dependency graph
          npm run build --prefix packages/semantic
          npm run build --prefix packages/core
          npm run build --prefix packages/i18n
          npm run build:browser --prefix packages/core
          npm run build --prefix packages/hyperscript-adapter
          npm run build --prefix packages/patterns-reference
          npm run build --prefix packages/ast-toolkit
          npm run build --prefix packages/mcp-server
          npm run build --prefix packages/vite-plugin

      - name: Run tests
        run: |
          npm test --prefix packages/core
          npm test --prefix packages/semantic -- --run
          npm test --prefix packages/i18n -- --run
          npm test --prefix packages/hyperscript-adapter -- --run
          npm test --prefix packages/mcp-server -- --run

      - name: Calculate new version
        id: version
        run: |
          # Get current version from core (all packages should be in sync)
          CURRENT=$(node -p "require('./packages/core/package.json').version")
          echo "Current version: $CURRENT"

          # Calculate new version
          cd packages/core
          npm version ${{ github.event.inputs.version-type }} --no-git-tag-version > /dev/null 2>&1
          NEW=$(node -p "require('./package.json').version")
          cd ../..

          # Reset core's package.json (we'll set all at once below)
          git checkout packages/core/package.json

          echo "New version: $NEW"
          echo "version=$NEW" >> $GITHUB_OUTPUT

      - name: Sync all package versions
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Setting all packages to version $VERSION"

          for pkg in semantic core i18n hyperscript-adapter patterns-reference mcp-server vite-plugin; do
            echo "  â†’ @lokascript/$pkg"
            cd "packages/$pkg"
            npm version "$VERSION" --no-git-tag-version --allow-same-version
            cd ../..
          done

      - name: Update package-lock.json
        run: npm install --package-lock-only

      - name: Publish to npm (dry-run)
        if: ${{ github.event.inputs.dry-run == 'true' }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "DRY RUN: Would publish all packages at version $VERSION"

          for pkg in semantic core i18n hyperscript-adapter patterns-reference mcp-server vite-plugin; do
            echo "  â†’ @lokascript/$pkg@$VERSION"
            cd "packages/$pkg"
            npm publish --dry-run --tag ${{ github.event.inputs.npm-tag }} --access public
            cd ../..
          done

      - name: Check authentication method
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -n "$NPM_TOKEN" ]; then
            echo "âœ… NPM_TOKEN secret is set (will use token auth)"
          else
            echo "â„¹ï¸  NPM_TOKEN secret not set (will use OIDC)"
          fi

      - name: Publish to npm
        if: ${{ github.event.inputs.dry-run == 'false' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Publishing all packages at version $VERSION"

          for pkg in semantic core i18n hyperscript-adapter patterns-reference mcp-server vite-plugin; do
            echo "Publishing @lokascript/$pkg@$VERSION"
            cd "packages/$pkg"

            if [ -z "$NODE_AUTH_TOKEN" ]; then
              echo "ðŸ” Using OIDC trusted publishing"
              rm -f .npmrc
              npm publish --tag ${{ github.event.inputs.npm-tag }} --access public --provenance
            else
              echo "ðŸ”‘ Using NPM_TOKEN authentication"
              echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > .npmrc
              npm publish --tag ${{ github.event.inputs.npm-tag }} --access public
              rm -f .npmrc
            fi

            cd ../..
          done

      - name: Commit version changes
        if: ${{ github.event.inputs.dry-run == 'false' }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git add packages/*/package.json package-lock.json
          git commit -m "chore: release v$VERSION" || echo "No changes to commit"

          git pull --rebase origin main || {
            git rebase --abort 2>/dev/null || true
            git pull --no-rebase origin main
          }

          git push

      - name: Create Git tags
        if: ${{ github.event.inputs.dry-run == 'false' }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Create unified version tag
          git tag -f "v$VERSION"
          git push origin "v$VERSION" --force

          # Create per-package tags
          for pkg in semantic core i18n hyperscript-adapter patterns-reference mcp-server vite-plugin; do
            TAG_NAME="@lokascript/${pkg}@${VERSION}"
            git tag -f "$TAG_NAME"
            git push origin "$TAG_NAME" --force
          done

      - name: Create GitHub Release
        if: ${{ github.event.inputs.dry-run == 'false' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ github.event.inputs.npm-tag }}"
          PRERELEASE_FLAG=""
          if [ "$TAG" != "latest" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          gh release create "v$VERSION" \
            --title "v$VERSION" \
            $PRERELEASE_FLAG \
            --notes "## @lokascript v${VERSION}

          All packages published at version ${VERSION}:
          - @lokascript/core
          - @lokascript/semantic
          - @lokascript/i18n
          - @lokascript/hyperscript-adapter
          - @lokascript/vite-plugin
          - @lokascript/mcp-server
          - @lokascript/patterns-reference

          ### Install
          \`\`\`bash
          npm install @lokascript/core@${VERSION}
          npm install @lokascript/vite-plugin@${VERSION}
          npm install @lokascript/hyperscript-adapter@${VERSION}
          \`\`\`"

      - name: Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "## Publication Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Version Type**: ${{ github.event.inputs.version-type }}" >> $GITHUB_STEP_SUMMARY
          echo "**npm Tag**: ${{ github.event.inputs.npm-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run**: ${{ github.event.inputs.dry-run }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages" >> $GITHUB_STEP_SUMMARY
          for pkg in semantic core i18n hyperscript-adapter patterns-reference mcp-server vite-plugin; do
            echo "- @lokascript/$pkg@$VERSION" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.dry-run }}" = "true" ]; then
            echo "âœ… **Dry run completed successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **All packages published successfully**" >> $GITHUB_STEP_SUMMARY
          fi
