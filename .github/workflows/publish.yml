name: Publish Packages

on:
  workflow_dispatch:
    inputs:
      version-type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - current
          - patch
          - minor
          - major
          - prerelease
        default: 'current'
      npm-tag:
        description: 'npm dist-tag (latest, beta, next, etc.)'
        required: true
        type: string
        default: 'latest'
      dry-run:
        description: 'Dry run (do not actually publish)'
        required: false
        type: boolean
        default: false

env:
  NODE_OPTIONS: --max-old-space-size=4096
  # All public packages to publish (in dependency order)
  # @lokascript: semantic, i18n, hyperscript-adapter, patterns-reference, mcp-server
  # @hyperfixi: core, vite-plugin
  PACKAGES: 'semantic,core,i18n,hyperscript-adapter,patterns-reference,mcp-server,vite-plugin'

jobs:
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Verify npm version
        run: |
          echo "Node: $(node --version)"
          echo "npm: $(npm --version)"
          # OIDC trusted publishing requires npm >= 11.5.1
          NPM_MAJOR=$(npm --version | cut -d. -f1)
          NPM_MINOR=$(npm --version | cut -d. -f2)
          if [ "$NPM_MAJOR" -lt 11 ] || { [ "$NPM_MAJOR" -eq 11 ] && [ "$NPM_MINOR" -lt 5 ]; }; then
            echo "::error::npm >= 11.5.1 required for OIDC trusted publishing"
            exit 1
          fi
          echo "✅ npm version OK for OIDC trusted publishing"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: npm install --prefer-offline

      - name: Build packages
        run: |
          # Build order based on dependency graph
          npm run build --prefix packages/semantic
          npm run build --prefix packages/core
          npm run build --prefix packages/i18n
          npm run build:browser --prefix packages/core
          npm run build --prefix packages/hyperscript-adapter
          npm run build --prefix packages/patterns-reference
          npm run build --prefix packages/ast-toolkit
          npm run build --prefix packages/compilation-service
          npm run build --prefix packages/mcp-server
          npm run build --prefix packages/vite-plugin

      - name: Run tests
        run: |
          npm test --prefix packages/core
          npm test --prefix packages/semantic -- --run
          npm test --prefix packages/i18n -- --run
          npm test --prefix packages/hyperscript-adapter -- --run
          npm test --prefix packages/mcp-server -- --run

      - name: Calculate new version
        id: version
        run: |
          # Get current version from core (all packages should be in sync)
          CURRENT=$(node -p "require('./packages/core/package.json').version")
          echo "Current version: $CURRENT"

          VERSION_TYPE="${{ github.event.inputs.version-type }}"

          if [ "$VERSION_TYPE" = "current" ]; then
            # Use the version already in package.json as-is
            NEW="$CURRENT"
          else
            # Calculate new version via npm version bump
            cd packages/core
            npm version "$VERSION_TYPE" --no-git-tag-version > /dev/null 2>&1
            NEW=$(node -p "require('./package.json').version")
            cd ../..

            # Reset core's package.json (we'll set all at once below)
            git checkout packages/core/package.json
          fi

          echo "New version: $NEW"
          echo "version=$NEW" >> $GITHUB_OUTPUT

      - name: Sync all package versions
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Setting all packages to version $VERSION"

          # Helper: get npm scope for a package
          pkg_scope() {
            case "$1" in
              core|vite-plugin|behaviors|types-browser|testing-framework|developer-tools|smart-bundling|aot-compiler) echo "@hyperfixi" ;;
              *) echo "@lokascript" ;;
            esac
          }

          for pkg in semantic core i18n hyperscript-adapter patterns-reference mcp-server vite-plugin; do
            echo "  → $(pkg_scope $pkg)/$pkg"
            cd "packages/$pkg"
            npm version "$VERSION" --no-git-tag-version --allow-same-version
            cd ../..
          done

      - name: Update package-lock.json
        run: npm install --package-lock-only

      - name: Publish to npm (dry-run)
        if: ${{ github.event.inputs.dry-run == 'true' }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "DRY RUN: Would publish all packages at version $VERSION"

          for pkg in semantic core i18n hyperscript-adapter patterns-reference mcp-server vite-plugin; do
            SCOPE=$(node -p "require('./packages/$pkg/package.json').name")
            echo "  → $SCOPE@$VERSION"
            cd "packages/$pkg"
            npm publish --dry-run --tag ${{ github.event.inputs.npm-tag }} --access public
            cd ../..
          done

      - name: Publish to npm
        if: ${{ github.event.inputs.dry-run == 'false' }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Publishing all packages at version $VERSION (OIDC trusted publishing)"

          for pkg in semantic core i18n hyperscript-adapter patterns-reference mcp-server vite-plugin; do
            SCOPE=$(node -p "require('./packages/$pkg/package.json').name")
            echo "Publishing $SCOPE@$VERSION"
            cd "packages/$pkg"
            npm publish --tag ${{ github.event.inputs.npm-tag }} --access public --provenance
            cd ../..
          done

      - name: Commit version changes
        if: ${{ github.event.inputs.dry-run == 'false' }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git add packages/*/package.json package-lock.json
          git commit -m "chore: release v$VERSION" || echo "No changes to commit"

          git pull --rebase origin main || {
            git rebase --abort 2>/dev/null || true
            git pull --no-rebase origin main
          }

          git push

      - name: Create Git tags
        if: ${{ github.event.inputs.dry-run == 'false' }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Create unified version tag
          git tag -f "v$VERSION"
          git push origin "v$VERSION" --force

          # Create per-package tags (use actual npm name from package.json)
          for pkg in semantic core i18n hyperscript-adapter patterns-reference mcp-server vite-plugin; do
            PKG_NAME=$(node -p "require('./packages/$pkg/package.json').name")
            TAG_NAME="${PKG_NAME}@${VERSION}"
            git tag -f "$TAG_NAME"
            git push origin "$TAG_NAME" --force
          done

      - name: Create GitHub Release
        if: ${{ github.event.inputs.dry-run == 'false' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ github.event.inputs.npm-tag }}"
          PRERELEASE_FLAG=""
          if [ "$TAG" != "latest" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          gh release create "v$VERSION" \
            --title "v$VERSION" \
            $PRERELEASE_FLAG \
            --notes "## HyperFixi + LokaScript v${VERSION}

          All packages published at version ${VERSION}:
          - @hyperfixi/core
          - @hyperfixi/vite-plugin
          - @lokascript/semantic
          - @lokascript/i18n
          - @lokascript/hyperscript-adapter
          - @lokascript/mcp-server
          - @lokascript/patterns-reference

          ### Install
          \`\`\`bash
          npm install @hyperfixi/core@${VERSION}
          npm install @hyperfixi/vite-plugin@${VERSION}
          npm install @lokascript/hyperscript-adapter@${VERSION}
          \`\`\`"

      - name: Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "## Publication Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Version Type**: ${{ github.event.inputs.version-type }}" >> $GITHUB_STEP_SUMMARY
          echo "**npm Tag**: ${{ github.event.inputs.npm-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run**: ${{ github.event.inputs.dry-run }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages" >> $GITHUB_STEP_SUMMARY
          for pkg in semantic core i18n hyperscript-adapter patterns-reference mcp-server vite-plugin; do
            PKG_NAME=$(node -p "require('./packages/$pkg/package.json').name")
            echo "- $PKG_NAME@$VERSION" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.dry-run }}" = "true" ]; then
            echo "✅ **Dry run completed successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ **All packages published successfully**" >> $GITHUB_STEP_SUMMARY
          fi
