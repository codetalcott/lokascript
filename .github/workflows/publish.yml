name: Publish Packages

on:
  workflow_dispatch:
    inputs:
      packages:
        description: 'Packages to publish (comma-separated, e.g., core,semantic,i18n)'
        required: true
        type: string
      version-type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - prerelease
          - custom
        default: 'patch'
      custom-version:
        description: 'Custom version (only if version-type is custom)'
        required: false
        type: string
      npm-tag:
        description: 'npm dist-tag (latest, beta, next, etc.)'
        required: true
        type: string
        default: 'latest'
      dry-run:
        description: 'Dry run (do not actually publish)'
        required: false
        type: boolean
        default: false

env:
  NODE_OPTIONS: --max-old-space-size=4096

jobs:
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write # For git push and creating releases
      id-token: write # For npm OIDC trusted publishing

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: npm ci

      - name: Build packages (must build before tests due to workspace imports)
        run: |
          # Build order based on dependency graph:
          # 1. semantic (no lokascript deps)
          # 2. core (depends on semantic)
          # 3. patterns-reference (depends on semantic)
          # 4. i18n (depends on core, semantic)
          # 5. ast-toolkit (optional dep for mcp-server, build even though private)
          # 6. mcp-server (depends on semantic, patterns-reference, ast-toolkit optional)
          # 7. vite-plugin (depends on core)
          npm run build --prefix packages/semantic
          npm run build --prefix packages/core
          npm run build --prefix packages/patterns-reference
          npm run build --prefix packages/i18n
          npm run build --prefix packages/ast-toolkit
          npm run build --prefix packages/mcp-server
          npm run build --prefix packages/vite-plugin

      - name: Run tests
        run: |
          npm test --prefix packages/core -- --run
          npm test --prefix packages/semantic -- --run
          npm test --prefix packages/i18n -- --run
          npm test --prefix packages/mcp-server -- --run

      - name: Parse package list
        id: packages
        run: |
          PACKAGES="${{ github.event.inputs.packages }}"
          echo "Packages to publish: $PACKAGES"
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT

      - name: Version bump
        if: ${{ github.event.inputs.version-type != 'custom' }}
        run: |
          IFS=',' read -ra PKG_ARRAY <<< "${{ steps.packages.outputs.packages }}"
          for pkg in "${PKG_ARRAY[@]}"; do
            pkg=$(echo "$pkg" | xargs)  # trim whitespace
            if [ -d "packages/$pkg" ]; then
              echo "Bumping version for @lokascript/$pkg (${{ github.event.inputs.version-type }})"
              cd "packages/$pkg"
              npm version ${{ github.event.inputs.version-type }} --no-git-tag-version
              cd ../..
            else
              echo "Warning: Package directory packages/$pkg not found"
            fi
          done

      - name: Set custom version
        if: ${{ github.event.inputs.version-type == 'custom' }}
        run: |
          IFS=',' read -ra PKG_ARRAY <<< "${{ steps.packages.outputs.packages }}"
          for pkg in "${PKG_ARRAY[@]}"; do
            pkg=$(echo "$pkg" | xargs)
            if [ -d "packages/$pkg" ]; then
              echo "Setting version for @lokascript/$pkg to ${{ github.event.inputs.custom-version }}"
              cd "packages/$pkg"
              npm version ${{ github.event.inputs.custom-version }} --no-git-tag-version --allow-same-version
              cd ../..
            fi
          done

      - name: Update package-lock.json
        run: npm install --package-lock-only

      - name: Publish to npm (dry-run)
        if: ${{ github.event.inputs.dry-run == 'true' }}
        run: |
          IFS=',' read -ra PKG_ARRAY <<< "${{ steps.packages.outputs.packages }}"
          for pkg in "${PKG_ARRAY[@]}"; do
            pkg=$(echo "$pkg" | xargs)
            if [ -d "packages/$pkg" ]; then
              echo "DRY RUN: Would publish @lokascript/$pkg with tag ${{ github.event.inputs.npm-tag }}"
              cd "packages/$pkg"
              npm publish --dry-run --tag ${{ github.event.inputs.npm-tag }} --access public
              cd ../..
            fi
          done

      # Uses OIDC trusted publishing by default - no NPM_TOKEN needed
      # Requires trusted publisher configured on npmjs.com for each package
      # Falls back to NPM_TOKEN if provided (useful for transitioning repos)
      - name: Check authentication method
        run: |
          if [ -n "${{ secrets.NPM_TOKEN }}" ]; then
            echo "âœ… NPM_TOKEN secret is set (will use token auth)"
          else
            echo "â„¹ï¸  NPM_TOKEN secret not set (will use OIDC)"
          fi

      - name: Publish to npm
        if: ${{ github.event.inputs.dry-run == 'false' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          IFS=',' read -ra PKG_ARRAY <<< "${{ steps.packages.outputs.packages }}"
          for pkg in "${PKG_ARRAY[@]}"; do
            pkg=$(echo "$pkg" | xargs)
            if [ -d "packages/$pkg" ]; then
              echo "Publishing @lokascript/$pkg with tag ${{ github.event.inputs.npm-tag }}"
              cd "packages/$pkg"

              # Use provenance if OIDC is available and no token is set
              if [ -z "$NODE_AUTH_TOKEN" ]; then
                echo "ðŸ” Using OIDC trusted publishing (with provenance)"
                # Remove any existing .npmrc to force OIDC
                rm -f .npmrc
                npm publish --tag ${{ github.event.inputs.npm-tag }} --access public --provenance
              else
                echo "ðŸ”‘ Using NPM_TOKEN authentication (remove secret to use OIDC)"
                echo "Token length: ${#NODE_AUTH_TOKEN} characters"
                # Explicitly set up .npmrc with token
                echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > .npmrc
                npm publish --tag ${{ github.event.inputs.npm-tag }} --access public
                rm -f .npmrc
              fi

              cd ../..
            fi
          done

      - name: Commit version changes
        if: ${{ github.event.inputs.dry-run == 'false' }}
        run: |
          git add packages/*/package.json package-lock.json
          git commit -m "chore: release ${{ steps.packages.outputs.packages }}" || echo "No changes to commit"
          git push

      - name: Create Git tags
        if: ${{ github.event.inputs.dry-run == 'false' }}
        run: |
          IFS=',' read -ra PKG_ARRAY <<< "${{ steps.packages.outputs.packages }}"
          for pkg in "${PKG_ARRAY[@]}"; do
            pkg=$(echo "$pkg" | xargs)
            if [ -d "packages/$pkg" ]; then
              VERSION=$(node -p "require('./packages/$pkg/package.json').version")
              git tag "@lokascript/${pkg}@${VERSION}"
              git push origin "@lokascript/${pkg}@${VERSION}"
            fi
          done

      - name: Create GitHub Release
        if: ${{ github.event.inputs.dry-run == 'false' && github.event.inputs.npm-tag == 'latest' }}
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: 'release-${{ github.run_number }}'
          release_name: 'Release ${{ steps.packages.outputs.packages }}'
          body: |
            Published packages: ${{ steps.packages.outputs.packages }}
            Version: ${{ github.event.inputs.version-type }}
            Tag: ${{ github.event.inputs.npm-tag }}

            See individual package CHANGELOGs for details.
          draft: false
          prerelease: ${{ github.event.inputs.npm-tag != 'latest' }}

      - name: Summary
        run: |
          echo "## Publication Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Packages**: ${{ steps.packages.outputs.packages }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version Type**: ${{ github.event.inputs.version-type }}" >> $GITHUB_STEP_SUMMARY
          echo "**npm Tag**: ${{ github.event.inputs.npm-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run**: ${{ github.event.inputs.dry-run }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.dry-run }}" = "true" ]; then
            echo "âœ… **Dry run completed successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No packages were published. Re-run with dry-run=false to publish." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Packages published successfully to npm**" >> $GITHUB_STEP_SUMMARY
          fi
