name: Publish Packages

on:
  workflow_dispatch:
    inputs:
      version-type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - current
          - patch
          - minor
          - major
          - prerelease
        default: 'current'
      npm-tag:
        description: 'npm dist-tag (latest, beta, next, etc.)'
        required: true
        type: string
        default: 'latest'
      dry-run:
        description: 'Dry run (do not actually publish)'
        required: false
        type: boolean
        default: false
      packages:
        description: 'Packages to publish (comma-separated subset, or "all")'
        required: false
        type: string
        default: 'all'

env:
  NODE_OPTIONS: --max-old-space-size=4096

jobs:
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: write
      id-token: write # Required for npm trusted publishing (OIDC provenance)

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'
          # No auth-token — OIDC trusted publishing handles authentication

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: |
          # Delete stale lockfile — workspace package versions may differ from lockfile
          # after a version bump. Regenerate fresh so workspace symlinks resolve correctly.
          rm -f package-lock.json
          npm install

      - name: Build all packages
        run: |
          # Build order: framework → semantic → core → i18n → core browser → rest
          # (core browser bundle requires i18n/dist/browser.js)
          npm run build --prefix packages/framework
          npm run build --prefix packages/semantic
          npm run build --prefix packages/core
          npm run build --prefix packages/i18n
          npm run build:browser --prefix packages/core
          npm run build --prefix packages/hyperscript-adapter
          npm run build --prefix packages/patterns-reference
          npm run build --prefix packages/aot-compiler
          npm run build --prefix packages/server-bridge
          npm run build --prefix packages/types-browser
          npm run build --prefix packages/domain-sql
          npm run build --prefix packages/domain-bdd
          npm run build --prefix packages/domain-llm
          npm run build --prefix packages/domain-todo
          npm run build --prefix packages/domain-behaviorspec
          npm run build --prefix packages/domain-jsx
          npm run build --prefix packages/domain-flow
          npm run build --prefix packages/compilation-service
          npm run build --prefix packages/mcp-server
          npm run build --prefix packages/vite-plugin
          npm run build --prefix packages/behaviors
          npm run build --prefix packages/testing-framework
          npm run build --prefix packages/language-server
          npm run build --prefix packages/mcp-server-hyperscript
          npm run build --prefix packages/language-server-hyperscript
          npm run build --prefix packages/multilingual-hyperscript

      - name: Run tests
        run: |
          npm test --prefix packages/core
          npm test --prefix packages/semantic -- --run
          npm test --prefix packages/i18n -- --run
          npm test --prefix packages/hyperscript-adapter -- --run
          npm test --prefix packages/compilation-service -- --run
          npm test --prefix packages/mcp-server -- --run

      - name: Calculate new version
        id: version
        run: |
          CURRENT=$(node -p "require('./packages/core/package.json').version")
          echo "Current version: $CURRENT"
          VERSION_TYPE="${{ github.event.inputs.version-type }}"

          if [ "$VERSION_TYPE" = "current" ]; then
            NEW="$CURRENT"
          else
            cd packages/core
            npm version "$VERSION_TYPE" --no-git-tag-version > /dev/null 2>&1
            NEW=$(node -p "require('./package.json').version")
            cd ../..
            git checkout packages/core/package.json
          fi

          echo "New version: $NEW"
          echo "version=$NEW" >> $GITHUB_OUTPUT

      - name: Sync all package versions
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Setting all packages to version $VERSION"
          for pkg in semantic core i18n hyperscript-adapter patterns-reference mcp-server vite-plugin \
                     framework server-bridge types-browser \
                     domain-sql domain-bdd domain-llm domain-todo domain-behaviorspec domain-jsx domain-flow \
                     compilation-service behaviors testing-framework language-server \
                     mcp-server-hyperscript language-server-hyperscript multilingual-hyperscript; do
            if [ -f "packages/$pkg/package.json" ]; then
              # Use npm pkg set to avoid registry lookups (safe for unpublished packages)
              (cd "packages/$pkg" && npm pkg set version="$VERSION")
            fi
          done

      - name: Publish packages
        env:
          # NPM_TOKEN required for initial publish of new packages
          # (OIDC trusted publishing only works for packages already on npm)
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -o pipefail
          VERSION="${{ steps.version.outputs.version }}"
          DRY_RUN="${{ github.event.inputs.dry-run }}"
          FILTER="${{ github.event.inputs.packages }}"
          FAILED=""

          # All packages in dependency order
          # Packages that have version-lock with core use the same VERSION
          # New domain/framework packages start at 1.0.0 but will be bumped if VERSION_TYPE != current
          ALL_PACKAGES="semantic core i18n hyperscript-adapter patterns-reference \
                        framework server-bridge types-browser \
                        domain-sql domain-bdd domain-llm domain-todo domain-behaviorspec domain-jsx domain-flow \
                        compilation-service mcp-server vite-plugin \
                        behaviors testing-framework language-server \
                        mcp-server-hyperscript language-server-hyperscript multilingual-hyperscript"

          for pkg in $ALL_PACKAGES; do
            [ ! -f "packages/$pkg/package.json" ] && continue

            # Skip if not in filter (unless filter is "all")
            if [ "$FILTER" != "all" ]; then
              PKG_NAME=$(node -p "require('./packages/$pkg/package.json').name")
              echo "$FILTER" | grep -qF "$PKG_NAME" || continue
            fi

            PKG_NAME=$(node -p "require('./packages/$pkg/package.json').name")
            PKG_VER=$(node -p "require('./packages/$pkg/package.json').version")
            IS_PRIVATE=$(node -p "require('./packages/$pkg/package.json').private || false")
            [ "$IS_PRIVATE" = "true" ] && continue

            echo "→ $PKG_NAME@$PKG_VER"

            if [ "$DRY_RUN" = "true" ]; then
              (cd "packages/$pkg" && npm publish --dry-run --access public \
                --tag "${{ github.event.inputs.npm-tag }}" 2>&1 | tail -3)
            else
              (cd "packages/$pkg" && npm publish --access public --provenance \
                --tag "${{ github.event.inputs.npm-tag }}" 2>&1 | tee /tmp/pub-$pkg.log) || {
                if grep -q "previously published\|already exists\|cannot publish over" /tmp/pub-$pkg.log 2>/dev/null; then
                  echo "  ⏭ already published, skipping"
                elif grep -q "Scope not found" /tmp/pub-$pkg.log 2>/dev/null; then
                  echo "  ⚠ scope not found on npm — create @${PKG_NAME%%/*} scope first"
                else
                  echo "  ✗ FAILED"
                  FAILED="$FAILED $PKG_NAME"
                fi
              }
            fi
          done

          if [ -n "$FAILED" ]; then
            echo "::error::Failed:$FAILED"
            exit 1
          fi

      - name: Commit version changes
        if: ${{ github.event.inputs.dry-run == 'false' }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Don't commit package-lock.json — it contains workspace-package versions that
          # would cause the next run's `npm install` to fail (tries to fetch old versions
          # from registry since they're now published but at a higher version number)
          git add packages/*/package.json 2>/dev/null || true
          git commit -m "chore: release v$VERSION" || echo "No changes to commit"
          git pull --rebase origin main || git pull --no-rebase origin main
          git push

      - name: Create Git tags
        if: ${{ github.event.inputs.dry-run == 'false' }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git tag -f "v$VERSION"
          git push origin "v$VERSION" --force

      - name: Create GitHub Release
        if: ${{ github.event.inputs.dry-run == 'false' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ github.event.inputs.npm-tag }}"
          PRERELEASE=$( [ "$TAG" != "latest" ] && echo "--prerelease" || echo "" )
          gh release create "v$VERSION" \
            --title "v$VERSION" $PRERELEASE \
            --generate-notes || echo "Release already exists"

      - name: Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          {
            echo "## Publication Summary"
            echo "**Version**: $VERSION | **Tag**: ${{ github.event.inputs.npm-tag }} | **Dry run**: ${{ github.event.inputs.dry-run }}"
            echo ""
            echo "### Packages published"
            for pkg in semantic core i18n hyperscript-adapter patterns-reference \
                       framework server-bridge types-browser \
                       domain-sql domain-bdd domain-llm domain-todo domain-behaviorspec domain-jsx domain-flow \
                       compilation-service mcp-server vite-plugin \
                       behaviors testing-framework language-server \
                       mcp-server-hyperscript language-server-hyperscript multilingual-hyperscript; do
              [ -f "packages/$pkg/package.json" ] || continue
              IS_PRIVATE=$(node -p "require('./packages/$pkg/package.json').private || false")
              [ "$IS_PRIVATE" = "true" ] && continue
              PKG_NAME=$(node -p "require('./packages/$pkg/package.json').name")
              PKG_VER=$(node -p "require('./packages/$pkg/package.json').version")
              echo "- \`$PKG_NAME@$PKG_VER\`"
            done
          } >> $GITHUB_STEP_SUMMARY
