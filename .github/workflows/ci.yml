name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_OPTIONS: --max-old-space-size=4096

jobs:
  # ============================================
  # Job 1: Build All Packages (runs once, shared by all jobs)
  # ============================================
  build:
    name: Build All Packages
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build semantic package
        run: npm run build --prefix packages/semantic

      - name: Build i18n package
        run: npm run build --prefix packages/i18n

      - name: Build core package (full)
        run: npm run build --prefix packages/core

      - name: Build patterns-reference package
        run: npm run build --prefix packages/patterns-reference

      - name: Build ast-toolkit package
        run: npm run build --prefix packages/ast-toolkit

      - name: Build developer-tools package
        run: npm run build --prefix packages/developer-tools

      - name: Build vite-plugin package
        run: npm run build --prefix packages/vite-plugin

      - name: Build all browser bundles
        run: npm run build:browser --prefix packages/core

      - name: Build semantic browser bundles
        run: npm run build:browser --prefix packages/semantic

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            packages/semantic/dist/
            packages/i18n/dist/
            packages/core/dist/
            packages/patterns-reference/dist/
            packages/ast-toolkit/dist/
            packages/developer-tools/dist/
            packages/vite-plugin/dist/
          retention-days: 1

  # ============================================
  # Job 2: Lint & Typecheck
  # ============================================
  lint-typecheck:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .

      - name: Rebuild workspace links
        run: |
          # Remove stale workspace symlinks and reinstall
          rm -rf node_modules/@lokascript
          npm install

      - name: Run ESLint (public packages)
        run: |
          npm run lint --prefix packages/core --if-present
          npm run lint --prefix packages/semantic --if-present
          npm run lint --prefix packages/i18n --if-present
          npm run lint --prefix packages/vite-plugin --if-present

      - name: Typecheck all packages
        run: |
          npm run typecheck --prefix packages/core
          npm run typecheck --prefix packages/semantic
          npm run typecheck --prefix packages/i18n
          npm run typecheck --prefix packages/vite-plugin
          npm run typecheck --prefix packages/patterns-reference

  # ============================================
  # Job 3: Unit Tests
  # ============================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .

      - name: Rebuild workspace links
        run: |
          # Remove stale workspace symlinks and reinstall
          rm -rf node_modules/@lokascript
          npm install

      - name: Test core
        run: npm test --prefix packages/core -- --run

      - name: Test semantic
        run: npm test --prefix packages/semantic -- --run

      - name: Test i18n
        run: npm test --prefix packages/i18n -- --run

      - name: Test vite-plugin
        run: npm test --prefix packages/vite-plugin -- --run

      - name: Test patterns-reference
        run: npm test --prefix packages/patterns-reference -- --run

  # ============================================
  # Job 4: Coverage Report (Node 20 only)
  # ============================================
  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .

      - name: Rebuild workspace links
        run: |
          # Remove stale workspace symlinks and reinstall
          rm -rf node_modules/@lokascript
          npm install

      - name: Generate coverage - core
        run: npm run test:coverage --prefix packages/core

      - name: Generate coverage - semantic
        run: npm test --prefix packages/semantic -- --run --coverage

      - name: Generate coverage - i18n
        run: npm run test:coverage --prefix packages/i18n

      - name: Upload core coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: packages/core/coverage/lcov.info
          flags: core
          name: core-coverage
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

      - name: Upload semantic coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: packages/semantic/coverage/lcov.info
          flags: semantic
          name: semantic-coverage
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

      - name: Upload i18n coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: packages/i18n/coverage/lcov.info
          flags: i18n
          name: i18n-coverage
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # ============================================
  # Job 5: Browser Tests (Playwright)
  # ============================================
  browser-tests:
    name: Browser Tests
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .

      - name: Rebuild workspace links
        run: |
          # Remove stale workspace symlinks and reinstall
          rm -rf node_modules/@lokascript
          npm install

      - name: Run Playwright tests
        run: npx playwright test --project=quick
        working-directory: packages/core
        continue-on-error: true # Known failures: behaviors not fully implemented

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: ./core/playwright-report/
          retention-days: 7

  # ============================================
  # Job 6: Multilingual Validation
  # ============================================
  multilingual-validation:
    name: Multilingual Validation
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .

      - name: Rebuild workspace links
        run: |
          # Remove stale workspace symlinks and reinstall
          rm -rf node_modules/@lokascript
          npm install

      - name: Populate patterns database
        run: npm run populate --prefix packages/patterns-reference

      - name: Test priority languages (quick mode)
        run: |
          cd packages/testing-framework
          npx tsx src/multilingual/cli.ts --languages en,ja,ko,es,zh,ar --quick
        continue-on-error: true # Shell spawning issues in CI environment may cause failures

      - name: Test supported languages (full mode)
        run: |
          cd packages/testing-framework
          # Excluding QU (Quechua), BN (Bengali), MS (Malay) - need more development
          # All languages now pass at 100% (JA, KO, TR, AR all fixed as of Jan 2026)
          # Hebrew (HE) added Jan 2026 after configuration fix
          npx tsx src/multilingual/cli.ts --languages ar,de,en,es,fr,he,hi,id,it,ja,ko,pl,pt,ru,sw,th,tl,tr,uk,vi,zh --full --bundle browser-priority
        continue-on-error: true # Shell spawning issues in CI environment may cause failures

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: multilingual-test-results
          path: ./testing-framework/test-results/
          retention-days: 30

  # ============================================
  # Job 7: Bundle Size Analysis
  # ============================================
  bundle-size:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .

      - name: Rebuild workspace links
        run: |
          # Remove stale workspace symlinks and reinstall
          rm -rf node_modules/@lokascript
          npm install

      - name: Analyze bundle sizes
        run: |
          echo "## Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Core Bundles" >> $GITHUB_STEP_SUMMARY
          echo "| Bundle | Size | Gzipped |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|---------|" >> $GITHUB_STEP_SUMMARY

          for file in packages/core/dist/lokascript-*.js; do
            if [[ -f "$file" && ! "$file" == *.map ]]; then
              filename=$(basename "$file")
              size=$(wc -c < "$file" | tr -d ' ')
              gzip_size=$(gzip -c "$file" | wc -c | tr -d ' ')
              size_kb=$((size / 1024))
              gzip_kb=$((gzip_size / 1024))
              echo "| $filename | ${size_kb} KB | ${gzip_kb} KB |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Semantic Bundles" >> $GITHUB_STEP_SUMMARY
          echo "| Bundle | Size | Gzipped |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|---------|" >> $GITHUB_STEP_SUMMARY

          for file in packages/semantic/dist/browser*.js; do
            if [[ -f "$file" && ! "$file" == *.map ]]; then
              filename=$(basename "$file")
              size=$(wc -c < "$file" | tr -d ' ')
              gzip_size=$(gzip -c "$file" | wc -c | tr -d ' ')
              size_kb=$((size / 1024))
              gzip_kb=$((gzip_size / 1024))
              echo "| $filename | ${size_kb} KB | ${gzip_kb} KB |" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Check size limits
        run: |
          # Size limits (gzipped bytes)
          MAX_LITE=4000           # 4 KB
          MAX_HYBRID=15000        # 15 KB
          MAX_BROWSER=230000      # 230 KB (actual: ~203-208 KB, allow headroom)

          failed=0

          if [[ -f "packages/core/dist/lokascript-lite.js" ]]; then
            size=$(gzip -c packages/core/dist/lokascript-lite.js | wc -c | tr -d ' ')
            if [[ "$size" -gt "$MAX_LITE" ]]; then
              echo "::warning::lokascript-lite.js ($size bytes gzip) exceeds limit ($MAX_LITE bytes)"
            fi
          fi

          if [[ -f "packages/core/dist/lokascript-hybrid-complete.js" ]]; then
            size=$(gzip -c packages/core/dist/lokascript-hybrid-complete.js | wc -c | tr -d ' ')
            if [[ "$size" -gt "$MAX_HYBRID" ]]; then
              echo "::warning::lokascript-hybrid-complete.js ($size bytes gzip) exceeds limit ($MAX_HYBRID bytes)"
            fi
          fi

          if [[ -f "packages/core/dist/lokascript-browser.js" ]]; then
            size=$(gzip -c packages/core/dist/lokascript-browser.js | wc -c | tr -d ' ')
            echo "browser.js gzipped: $size bytes (limit: $MAX_BROWSER bytes)"
            if [[ "$size" -gt "$MAX_BROWSER" ]]; then
              echo "::warning::lokascript-browser.js ($size bytes gzip) exceeds limit ($MAX_BROWSER bytes)"
            fi
          fi

          exit $failed

  # ============================================
  # Job 8: Performance Benchmarks (main branch only)
  # ============================================
  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .

      - name: Rebuild workspace links
        run: |
          # Remove stale workspace symlinks and reinstall
          rm -rf node_modules/@lokascript
          npm install

      - name: Run benchmarks
        run: npm run bench:run --prefix packages/core
        continue-on-error: true

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: ./core/benchmark-results/
          retention-days: 30
