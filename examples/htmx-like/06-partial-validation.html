<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>06: Partial Validation - HyperFixi htmx-like Examples</title>
  <link rel="stylesheet" href="../gallery.css">
  <style>
    /* Example-specific styles */
    .info.warning {
      background: #fef3c7;
      border-left-color: #f59e0b;
    }
    .info.error {
      background: #fee2e2;
      border-left-color: #dc2626;
    }
    #swap-target {
      min-height: 100px;
      background: var(--color-surface, #f4f4f5);
      padding: 15px;
      border-radius: 4px;
    }
    #validation-log {
      background: var(--code-bg);
      color: var(--code-text);
      padding: 15px;
      font-family: var(--font-mono);
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
      border-radius: 8px;
      white-space: pre-wrap;
    }
    .log-critical { color: #f87171; }
    .log-structural { color: #fb923c; }
    .log-warning { color: #facc15; }
    .log-info { color: #60a5fa; }
    .log-success { color: #4ade80; }
    .config-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    .config-option {
      padding: 10px;
      background: var(--color-surface, #f4f4f5);
      border-radius: 4px;
    }
    .config-option label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    select, input[type="text"] {
      width: 100%;
      padding: 6px;
      border: 1px solid var(--color-border, #e4e4e7);
      border-radius: 4px;
      background: var(--color-surface, #ffffff);
      color: var(--color-text, #18181b);
    }
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
    }
    .button-group button {
      flex: 1;
      min-width: 150px;
    }
    textarea {
      width: 100%;
      font-family: var(--font-mono);
      padding: 10px;
      border: 1px solid var(--color-border, #e4e4e7);
      border-radius: 4px;
      background: var(--color-surface, #ffffff);
      color: var(--color-text, #18181b);
    }
  </style>
</head>
<body class="example-page">
  <div class="page-container">
    <div class="breadcrumb">
      <a href="../index.html">← Back to Gallery</a> / <strong>htmx-like</strong> / 06: Partial Validation
    </div>

    <h1>Partial Template Validation</h1>

    <div class="description">
      <strong>Purpose:</strong> Demonstrates development-time validation that catches common errors when
      partial templates accidentally contain layout elements (<code>&lt;html&gt;</code>, <code>&lt;body&gt;</code>)
      or duplicate semantic landmarks (<code>&lt;header&gt;</code>, <code>&lt;footer&gt;</code>).
      <br><br>
      <strong>Open your browser's DevTools console</strong> to see styled warnings when swapping problematic content.
    </div>

    <div>
      <span class="tag htmx">validation</span>
      <span class="tag">partial templates</span>
      <span class="tag">developer tools</span>
    </div>

    <h2>Configuration</h2>
    <div class="demo">
      <div class="config-panel">
        <div class="config-option">
          <label>Strictness Level</label>
          <select id="strictness-select">
            <option value="relaxed">Relaxed (critical only)</option>
            <option value="standard" selected>Standard (critical + structural)</option>
            <option value="strict">Strict (all warnings)</option>
          </select>
        </div>
        <div class="config-option">
          <label>Show Warnings</label>
          <select id="warnings-select">
            <option value="true" selected>Enabled</option>
            <option value="false">Disabled</option>
          </select>
        </div>
        <div class="config-option">
          <label>Additional Critical Elements</label>
          <input type="text" id="critical-elements" placeholder="e.g., app-shell, app-layout">
        </div>
      </div>
      <button onclick="applyConfig()" style="margin-top: 15px;">Apply Configuration</button>
    </div>

    <h2>Swap Target</h2>
    <div class="demo">
      <div id="swap-target">
        <p>This is the swap target. Content will be swapped here.</p>
        <p>Current time: <span id="current-time"></span></p>
      </div>
    </div>

    <h2>Test Scenarios</h2>

    <div class="demo">
      <h3>Critical Issues (Always Detected)</h3>
      <p class="description info error">These represent serious errors where a server returns a full page instead of a partial.</p>
      <div class="button-group">
        <button onclick="swapWithHtml()">
          Swap with &lt;html&gt; (Full Page)
        </button>
        <button onclick="swapWithBody()">
          Swap with &lt;body&gt;
        </button>
        <button onclick="swapWithHead()">
          Swap with &lt;head&gt;
        </button>
        <button onclick="swapWithDoctype()">
          Swap with DOCTYPE
        </button>
      </div>
    </div>

    <div class="demo">
      <h3>Structural Issues (Standard/Strict Mode)</h3>
      <p class="description info warning">These may cause duplicate semantic landmarks, affecting accessibility.</p>
      <div class="button-group">
        <button onclick="swapWithHeader()">
          Swap with &lt;header&gt;
        </button>
        <button onclick="swapWithFooter()">
          Swap with &lt;footer&gt;
        </button>
        <button onclick="swapWithMain()">
          Swap with &lt;main&gt;
        </button>
        <button onclick="swapWithNav()">
          Swap with &lt;nav&gt;
        </button>
      </div>
    </div>

    <div class="demo">
      <h3>Valid Partial Content</h3>
      <p class="description">These are valid partial templates that should pass validation.</p>
      <div class="button-group">
        <button onclick="swapValidContent()">
          Swap Valid Content
        </button>
        <button onclick="swapArticle()">
          Swap &lt;article&gt;
        </button>
        <button onclick="swapForm()">
          Swap &lt;form&gt;
        </button>
      </div>
    </div>

    <h2>Validation Log</h2>
    <div id="validation-log">Waiting for swap operations...</div>
    <button onclick="clearLog()" class="secondary" style="margin-top: 10px;">Clear Log</button>

    <h2>Manual Validation API</h2>
    <div class="demo">
      <p>You can also validate HTML content manually without swapping:</p>
      <textarea id="manual-html" rows="4" placeholder="Enter HTML to validate, e.g.: <html><body>content</body></html>"></textarea>
      <button onclick="validateManual()" style="margin-top: 10px;">Validate HTML</button>
    </div>

    <!-- Navigation -->
    <div class="nav-buttons">
      <a href="05-boosted-links.html">← Previous: Boosted Links</a>
      <a href="../index.html">Back to Gallery →</a>
    </div>
  </div>

  <script src="../../packages/core/dist/hyperfixi-browser.js"></script>
  <script>
    // Get validation functions from hyperfixi
    const {
      validatePartialContent,
      configurePartialValidation,
      getPartialValidationConfig,
      resetPartialValidationConfig,
      emitPartialValidationWarnings,
      formatResultSummary
    } = window.hyperfixi ? window.hyperfixi : {};

    // Check if validation is available
    if (!validatePartialContent) {
      document.getElementById('validation-log').innerHTML =
        '<span class="log-critical">ERROR: Partial validation not available. Make sure hyperfixi-browser.js is loaded.</span>';
    }

    // Initialize with validation enabled
    if (configurePartialValidation) {
      configurePartialValidation({ enabled: true, showWarnings: true });
    }

    // Update time display
    function updateTime() {
      const timeEl = document.getElementById('current-time');
      if (timeEl) timeEl.textContent = new Date().toLocaleTimeString();
    }
    updateTime();
    setInterval(updateTime, 1000);

    // Logging utility
    function log(message, type = 'info') {
      const logEl = document.getElementById('validation-log');
      const timestamp = new Date().toLocaleTimeString();
      const className = `log-${type}`;
      logEl.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function clearLog() {
      document.getElementById('validation-log').innerHTML = 'Log cleared.\n';
    }

    // Apply configuration
    function applyConfig() {
      const strictness = document.getElementById('strictness-select').value;
      const showWarnings = document.getElementById('warnings-select').value === 'true';
      const criticalElements = document.getElementById('critical-elements').value
        .split(',')
        .map(s => s.trim())
        .filter(s => s);

      configurePartialValidation({
        enabled: true,
        strictness,
        showWarnings,
        additionalCriticalElements: criticalElements.length > 0 ? criticalElements : undefined,
      });

      log(`Configuration updated: strictness=${strictness}, showWarnings=${showWarnings}`, 'info');
      if (criticalElements.length > 0) {
        log(`  Additional critical elements: ${criticalElements.join(', ')}`, 'info');
      }
    }

    // Swap and validate helper
    function swapAndValidate(html, description) {
      log(`\n--- ${description} ---`, 'info');
      log(`Content: ${html.substring(0, 100)}${html.length > 100 ? '...' : ''}`, 'info');

      // Validate first
      const result = validatePartialContent(html, '#swap-target');

      if (result.totalIssues > 0) {
        log(`Validation: ${formatResultSummary(result)}`, result.valid ? 'warning' : 'critical');

        result.issues.forEach(issue => {
          const icon = issue.severity === 'critical' ? '!!' : issue.severity === 'structural' ? '!' : '*';
          log(`  ${icon} <${issue.element}>: ${issue.message}`, issue.severity);
        });

        // Also emit to console for styled output
        emitPartialValidationWarnings(result);
      } else {
        log('Validation: No issues found', 'success');
      }

      // Always proceed with swap (non-blocking)
      const target = document.getElementById('swap-target');
      target.innerHTML = html;
      log('Swap completed (validation is non-blocking)', 'info');
    }

    // Test scenarios
    function swapWithHtml() {
      swapAndValidate(
        '<!DOCTYPE html><html><head><title>Full Page</title></head><body><div>This is a full page!</div></body></html>',
        'Full page with <html> and <body>'
      );
    }

    function swapWithBody() {
      swapAndValidate(
        '<body><div class="content"><h2>Body Content</h2><p>This partial contains a body element.</p></div></body>',
        'Partial with <body> element'
      );
    }

    function swapWithHead() {
      swapAndValidate(
        '<head><title>Title</title><link rel="stylesheet" href="style.css"></head><div>Content</div>',
        'Partial with <head> element'
      );
    }

    function swapWithDoctype() {
      swapAndValidate(
        '<!DOCTYPE html><div class="content"><h2>DOCTYPE Present</h2><p>This partial has a DOCTYPE declaration.</p></div>',
        'Partial with DOCTYPE'
      );
    }

    function swapWithHeader() {
      swapAndValidate(
        '<header><nav><a href="/">Home</a> | <a href="/about">About</a></nav></header><div class="content"><p>Main content here.</p></div>',
        'Partial with <header> element'
      );
    }

    function swapWithFooter() {
      swapAndValidate(
        '<div class="content"><p>Content above footer.</p></div><footer><p>&copy; 2024 Company</p></footer>',
        'Partial with <footer> element'
      );
    }

    function swapWithMain() {
      swapAndValidate(
        '<main><article><h2>Article Title</h2><p>Article content.</p></article></main>',
        'Partial with <main> element'
      );
    }

    function swapWithNav() {
      swapAndValidate(
        '<nav><ul><li><a href="/">Home</a></li><li><a href="/products">Products</a></li></ul></nav>',
        'Partial with <nav> element'
      );
    }

    function swapValidContent() {
      swapAndValidate(
        `<div class="card"><h2>Valid Partial Content</h2><p>Updated at ${new Date().toLocaleTimeString()}</p><button onclick="alert('Clicked!')">Click Me</button></div>`,
        'Valid partial (div with content)'
      );
    }

    function swapArticle() {
      swapAndValidate(
        '<article><h2>Article Title</h2><p>This is a valid article element in a partial.</p><time datetime="2024-01-15">January 15, 2024</time></article>',
        'Valid partial (article element)'
      );
    }

    function swapForm() {
      swapAndValidate(
        '<form><label>Name: <input type="text" name="name"></label><label>Email: <input type="email" name="email"></label><button type="submit">Submit</button></form>',
        'Valid partial (form element)'
      );
    }

    function validateManual() {
      const html = document.getElementById('manual-html').value;
      if (!html.trim()) {
        log('Please enter HTML to validate', 'warning');
        return;
      }
      swapAndValidate(html, 'Manual validation');
    }

    // Initial log message
    log('Partial validation demo loaded', 'success');
    log('Open DevTools console to see styled warnings', 'info');
    log(`Current config: ${JSON.stringify(getPartialValidationConfig())}`, 'info');
  </script>
</body>
</html>
