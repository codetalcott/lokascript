<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>05: State Machine - HyperFixi Examples</title>
    <link rel="stylesheet" href="../gallery.css">
    <style>
        /* Example-specific styles */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        button.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        button.warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .state-machine {
            display: flex;
            gap: 30px;
            margin: 30px 0;
        }

        .state-diagram {
            flex: 1;
            background: var(--panel-muted);
            padding: 30px;
            border-radius: 12px;
        }

        .state-box {
            background: var(--panel);
            border: 3px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            transition: all 0.3s ease;
        }

        .state-box.active {
            border-color: var(--accent-primary);
            background: linear-gradient(135deg, var(--tag-default-bg) 0%, #bbdefb 100%);
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .state-name {
            font-weight: bold;
            font-size: 18px;
            color: var(--text);
            margin-bottom: 5px;
        }

        .state-description {
            color: var(--text-muted);
            font-size: 14px;
        }

        .state-controls {
            flex: 1;
            background: var(--panel-muted);
            padding: 30px;
            border-radius: 12px;
        }

        .state-info {
            background: var(--accent-gradient);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .current-state {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .state-details {
            font-size: 14px;
            opacity: 0.9;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .history {
            background: var(--panel);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .history-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text);
        }

        .history-item {
            padding: 8px 12px;
            background: var(--panel-muted);
            border-radius: 4px;
            margin: 5px 0;
            font-size: 14px;
            color: var(--text-muted);
        }

        .history-item .timestamp {
            color: var(--text-muted);
            font-size: 12px;
        }

        .order-summary {
            background: var(--panel);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .summary-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 18px;
        }

        .arrow {
            text-align: center;
            color: var(--text-muted);
            font-size: 24px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .state-machine {
                flex-direction: column;
            }
        }
    </style>
</head>
<body class="example-page">
    <div class="page-container">
        <div class="breadcrumb">
            <a href="../index.html">← Back to Gallery</a> / <strong>Advanced</strong> / 05: State Machine
        </div>

        <h1>State Machine</h1>

        <div class="description">
            <strong>Manage complex workflows with state machines</strong><br>
            Learn how to implement state machines using hyperscript for managing multi-step
            processes, workflows, and complex UI states. Perfect for checkout flows, wizards, and game logic!
        </div>

        <div>
            <span class="tag">state management</span>
            <span class="tag">workflows</span>
            <span class="tag">transitions</span>
            <span class="tag">guards</span>
        </div>

        <!-- Demo -->
        <div class="demo">
            <h2>Order Processing State Machine</h2>
            <p>This demo shows a complete order workflow with state transitions and guards:</p>

            <div id="state-machine"
                 _="init
                      -- Initialize state machine
                      set :state to 'cart'
                      set :orderTotal to 0
                      set :paymentMethod to null
                      set :history to []

                      -- Add initial history entry
                      call :history.push({
                        state: 'cart',
                        timestamp: new Date().toLocaleTimeString(),
                        action: 'Initialized'
                      })
                      send updateHistory
                      send updateUI
                    end

                    -- Helper to add history entry
                    on addHistory(action)
                      call :history.push({
                        state: :state,
                        timestamp: new Date().toLocaleTimeString(),
                        action: action
                      })
                      send updateHistory
                    end

                    -- Helper to update history display
                    on updateHistory
                      set html to ''
                      for entry in :history
                        set html to html + `<div class='history-item'>
                          <strong>${entry.action}</strong> in ${entry.state}
                          <div class='timestamp'>${entry.timestamp}</div>
                        </div>`
                      end
                      put html into #history-list
                    end

                    -- Helper to update UI based on current state
                    on updateUI
                      -- Update state boxes (remove .active from all)
                      for box in .state-box
                        remove .active from box
                      end
                      -- Dynamic selector: get element by id using state variable
                      call document.getElementById('state-' + :state)
                      add .active to it

                      -- Update current state display using if/else for state names
                      if :state is 'cart'
                        put 'Shopping Cart' into #current-state
                      else if :state is 'checkout'
                        put 'Checkout' into #current-state
                      else if :state is 'payment'
                        put 'Payment' into #current-state
                      else if :state is 'processing'
                        put 'Processing' into #current-state
                      else if :state is 'completed'
                        put 'Completed' into #current-state
                      else if :state is 'cancelled'
                        put 'Cancelled' into #current-state
                      end

                      -- Enable/disable buttons based on state
                      if :state is 'cart'
                        set #btn-checkout's disabled to false
                        set #btn-payment's disabled to true
                        set #btn-process's disabled to true
                        set #btn-cancel's disabled to false
                      else if :state is 'checkout'
                        set #btn-checkout's disabled to true
                        set #btn-payment's disabled to false
                        set #btn-process's disabled to true
                        set #btn-cancel's disabled to false
                      else if :state is 'payment'
                        set #btn-checkout's disabled to true
                        set #btn-payment's disabled to true
                        set #btn-process's disabled to false
                        set #btn-cancel's disabled to false
                      else if :state is 'processing'
                        set #btn-checkout's disabled to true
                        set #btn-payment's disabled to true
                        set #btn-process's disabled to true
                        set #btn-cancel's disabled to true
                      else
                        set #btn-checkout's disabled to true
                        set #btn-payment's disabled to true
                        set #btn-process's disabled to true
                        set #btn-cancel's disabled to true
                      end
                    end

                    -- Transition to checkout
                    on checkout
                      if :state is 'cart'
                        set :state to 'checkout'
                        set :orderTotal to 129.99
                        put '$' + :orderTotal into #order-total
                        send addHistory('Proceeded to checkout')
                        send updateUI
                      end
                    end

                    -- Transition to payment
                    on payment
                      if :state is 'checkout'
                        set :state to 'payment'
                        send addHistory('Entered payment info')
                        send updateUI
                      end
                    end

                    -- Process order
                    on process
                      if :state is 'payment'
                        set :state to 'processing'
                        send addHistory('Processing payment')
                        send updateUI

                        -- Simulate payment processing
                        wait 2s

                        set :state to 'completed'
                        send addHistory('Order completed')
                        send updateUI
                      end
                    end

                    -- Cancel order
                    on cancel
                      if :state is not 'completed' and :state is not 'cancelled' and :state is not 'processing'
                        set :state to 'cancelled'
                        send addHistory('Order cancelled')
                        send updateUI
                      end
                    end

                    -- Reset machine
                    on reset
                      set :state to 'cart'
                      set :orderTotal to 0
                      set :paymentMethod to null
                      set :history to []
                      call :history.push({
                        state: 'cart',
                        timestamp: new Date().toLocaleTimeString(),
                        action: 'Reset to cart'
                      })
                      send updateHistory
                      send updateUI
                      put '$0.00' into #order-total
                    end"
                 class="state-machine">

                <div class="state-diagram">
                    <h3 style="margin-top: 0;">State Flow</h3>

                    <div id="state-cart" class="state-box active">
                        <div class="state-name">Cart</div>
                        <div class="state-description">Add items to cart</div>
                    </div>

                    <div class="arrow">↓</div>

                    <div id="state-checkout" class="state-box">
                        <div class="state-name">Checkout</div>
                        <div class="state-description">Review order details</div>
                    </div>

                    <div class="arrow">↓</div>

                    <div id="state-payment" class="state-box">
                        <div class="state-name">Payment</div>
                        <div class="state-description">Enter payment info</div>
                    </div>

                    <div class="arrow">↓</div>

                    <div id="state-processing" class="state-box">
                        <div class="state-name">Processing</div>
                        <div class="state-description">Processing payment</div>
                    </div>

                    <div class="arrow">↓</div>

                    <div id="state-completed" class="state-box">
                        <div class="state-name">Completed</div>
                        <div class="state-description">Order confirmed</div>
                    </div>

                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px dashed var(--border);">
                        <div id="state-cancelled" class="state-box">
                            <div class="state-name">Cancelled</div>
                            <div class="state-description">Order cancelled</div>
                        </div>
                    </div>
                </div>

                <div class="state-controls">
                    <div class="state-info">
                        <div class="current-state">Current State: <span id="current-state">Shopping Cart</span></div>
                        <div class="state-details">Click buttons to transition between states</div>
                    </div>

                    <div class="action-buttons">
                        <button id="btn-checkout" _="on click send checkout to #state-machine">
                            Proceed to Checkout
                        </button>
                        <button id="btn-payment" disabled _="on click send payment to #state-machine">
                            Enter Payment
                        </button>
                        <button id="btn-process" disabled class="success" _="on click send process to #state-machine">
                            Complete Order
                        </button>
                        <button id="btn-cancel" class="secondary" _="on click send cancel to #state-machine">
                            Cancel Order
                        </button>
                        <button class="warning" _="on click send reset to #state-machine">
                            Reset Demo
                        </button>
                    </div>

                    <div class="order-summary">
                        <h3 style="margin-top: 0;">Order Summary</h3>
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span id="order-total">$0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Shipping:</span>
                            <span>$10.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Tax:</span>
                            <span>$12.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Total:</span>
                            <span>$151.99</span>
                        </div>
                    </div>

                    <div class="history">
                        <div class="history-title">State History</div>
                        <div id="history-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Code Explanation -->
        <h2>The Code</h2>

        <h3>State Machine Initialization:</h3>
        <div class="code">
&lt;div <span class="keyword">id</span>=<span class="string">"state-machine"</span>
     <span class="keyword">_</span>=<span class="string">"init
          set :state to 'idle'
          set :data to {}
        end

        on updateUI
          -- Update UI based on current state
          for box in .state-box
            remove .active from box
          end
          add .active to #state-{:state}
        end"</span>&gt;
&lt;/div&gt;
        </div>

        <h3>State Transition with Guard:</h3>
        <div class="code">
&lt;button <span class="keyword">_</span>=<span class="string">"on click
         -- Guard: Check if transition is allowed
         if :state is 'checkout' and :paymentValid
           set :state to 'payment'
           send updateUI to #state-machine
         else
           log 'Cannot transition: conditions not met'
         end"</span>&gt;
  Next Step
&lt;/button&gt;
        </div>

        <h3>State Transition Handler:</h3>
        <div class="code">
&lt;div <span class="keyword">_</span>=<span class="string">"on checkout
       if :state is 'cart'
         set :state to 'checkout'
         call :history.push({
           from: 'cart',
           to: 'checkout',
           timestamp: Date.now()
         })
         send updateUI
       end
     end"</span>&gt;
&lt;/div&gt;
        </div>

        <div class="explanation">
            <h3>How it works:</h3>
            <ul>
                <li><code>:state</code> - Local variable tracking current state</li>
                <li><code>init</code> - Initialization block for setting up state machine</li>
                <li><code>on eventName</code> - Custom event handlers for state transitions</li>
                <li><code>send event to #element</code> - Trigger state transitions</li>
                <li><strong>Guards:</strong> Conditional checks before allowing transitions</li>
            </ul>

            <h3>Key Concepts:</h3>
            <ul>
                <li><strong>States:</strong> Discrete modes of the system (cart, checkout, payment, etc.)</li>
                <li><strong>Transitions:</strong> Allowed movements between states</li>
                <li><strong>Guards:</strong> Conditions that must be met for transitions</li>
                <li><strong>Actions:</strong> Side effects when entering/leaving states</li>
                <li><strong>Events:</strong> Triggers that cause state transitions</li>
            </ul>

            <h3>State Machine Pattern:</h3>
            <div class="code">
<span class="comment">-- Define states</span>
set :states to ['idle', 'loading', 'success', 'error']

<span class="comment">-- Define allowed transitions</span>
set :transitions to {
  idle: ['loading'],
  loading: ['success', 'error'],
  success: ['idle'],
  error: ['idle']
}

<span class="comment">-- Transition with validation</span>
on transition(newState)
  if :transitions[:state].includes(newState)
    set oldState to :state
    set :state to newState

    <span class="comment">-- Execute exit action for old state</span>
    send exitState(oldState)

    <span class="comment">-- Execute entry action for new state</span>
    send enterState(newState)

    <span class="comment">-- Update UI</span>
    send updateUI
  else
    log 'Invalid transition from ' + :state + ' to ' + newState
  end
end
            </div>

            <h3>Advanced Patterns:</h3>
            <div class="code">
<span class="comment">&lt;!-- Nested state machines --&gt;</span>
&lt;div <span class="keyword">_</span>=<span class="string">"init
       set :parentState to 'active'
       set :childState to 'editing'
     end

     on transition(newState)
       if newState is in :allowedStates
         set :parentState to newState
         -- Reset child state on parent transition
         set :childState to getInitialChildState(newState)
       end
     end"</span>&gt;
&lt;/div&gt;

<span class="comment">&lt;!-- State machine with history --&gt;</span>
&lt;div <span class="keyword">_</span>=<span class="string">"init
       set :stateStack to ['idle']
     end

     on pushState(newState)
       call :stateStack.push(:state)
       set :state to newState
       send updateUI
     end

     on popState
       if :stateStack.length > 0
         set :state to :stateStack.pop()
         send updateUI
       end
     end"</span>&gt;
&lt;/div&gt;

<span class="comment">&lt;!-- Timed transitions --&gt;</span>
&lt;div <span class="keyword">_</span>=<span class="string">"on enterState(state)
       if state is 'processing'
         wait 5s
         if :state is still 'processing'
           send transition('timeout')
         end
       end
     end"</span>&gt;
&lt;/div&gt;

<span class="comment">&lt;!-- Parallel states --&gt;</span>
&lt;div <span class="keyword">_</span>=<span class="string">"init
       set :connectionState to 'disconnected'
       set :authState to 'unauthenticated'
       set :dataState to 'empty'
     end

     on connect
       set :connectionState to 'connected'
       if :authState is 'authenticated'
         send loadData
       end
     end"</span>&gt;
&lt;/div&gt;
            </div>

            <h3>Common Use Cases:</h3>
            <ul>
                <li><strong>Checkout Flows:</strong> Cart -> Checkout -> Payment -> Confirmation</li>
                <li><strong>Multi-Step Forms:</strong> Personal Info -> Address -> Payment -> Review</li>
                <li><strong>Game Logic:</strong> Menu -> Playing -> Paused -> GameOver</li>
                <li><strong>Authentication:</strong> LoggedOut -> LoggingIn -> LoggedIn -> LoggingOut</li>
                <li><strong>Upload Workflow:</strong> Idle -> Selecting -> Uploading -> Success/Error</li>
                <li><strong>Connection States:</strong> Disconnected -> Connecting -> Connected -> Error</li>
            </ul>

            <h3>Benefits of State Machines:</h3>
            <ul>
                <li><strong>Predictability:</strong> Clear rules for state transitions</li>
                <li><strong>Debuggability:</strong> Easy to track state history and transitions</li>
                <li><strong>Maintainability:</strong> Explicit state logic vs scattered conditionals</li>
                <li><strong>Testability:</strong> Well-defined inputs and outputs</li>
                <li><strong>Visualization:</strong> Can be represented as diagrams</li>
            </ul>

            <h3>State Machine Best Practices:</h3>
            <ul>
                <li>Keep states mutually exclusive (only one active at a time)</li>
                <li>Use guards to prevent invalid transitions</li>
                <li>Log state transitions for debugging</li>
                <li>Separate state logic from UI updates</li>
                <li>Consider using XState library for complex machines</li>
                <li>Document allowed transitions clearly</li>
            </ul>

            <h3>Try it yourself:</h3>
            <ul>
                <li>Add more states (e.g., 'shipping', 'review')</li>
                <li>Implement state persistence with localStorage</li>
                <li>Add animation transitions between states</li>
                <li>Create a wizard with prev/next navigation</li>
                <li>Build a game with state-based logic</li>
                <li>Add error recovery states and retry logic</li>
            </ul>
        </div>

        <!-- Navigation -->
        <div class="nav-buttons">
            <a href="04-infinite-scroll.html">← Previous: Infinite Scroll</a>
            <a href="../index.html">Back to Gallery →</a>
        </div>
    </div>

    <!-- Load HyperFixi -->
    <script src="../../packages/core/dist/hyperfixi-browser.js"></script>
    <script src="../debug-panel.js"></script>
</body>
</html>
