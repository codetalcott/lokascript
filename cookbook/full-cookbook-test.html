<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HyperFixi Complete Cookbook Test</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    h1 {
      color: #333;
      border-bottom: 3px solid #007bff;
      padding-bottom: 10px;
    }

    h2 {
      color: #555;
      margin-top: 40px;
      padding: 10px;
      background: #e9ecef;
      border-left: 4px solid #007bff;
    }

    .example {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .example-title {
      font-weight: bold;
      color: #007bff;
      margin-bottom: 10px;
    }

    .example-description {
      color: #666;
      font-size: 14px;
      margin-bottom: 15px;
      font-style: italic;
    }

    .code-block {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }

    .demo-area {
      padding: 15px;
      border: 2px dashed #007bff;
      border-radius: 4px;
      margin: 15px 0;
      background: #f8f9fa;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      margin: 5px;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    input[type="text"], input[type="checkbox"] {
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
    }

    input[type="text"] {
      width: 300px;
    }

    .status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }

    .status-pass {
      background: #d4edda;
      color: #155724;
    }

    .status-fail {
      background: #f8d7da;
      color: #721c24;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    #quotes {
      height: 300px;
      overflow-y: scroll;
      border: 1px solid #dee2e6;
      padding: 15px;
      background: white;
    }

    #quotes blockquote {
      border-left: 4px solid #007bff;
      padding-left: 15px;
      margin: 15px 0;
      color: #555;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }

    th, td {
      padding: 10px;
      border: 1px solid #dee2e6;
      text-align: left;
    }

    th {
      background: #e9ecef;
      font-weight: bold;
    }

    tbody {
      display: block;
      height: 200px;
      overflow-y: scroll;
    }

    thead, tbody tr {
      display: table;
      width: 100%;
      table-layout: fixed;
    }

    pre {
      background: #f8f9fa;
      border: 2px dashed #dee2e6;
      padding: 20px;
      margin: 15px 0;
      border-radius: 4px;
      min-height: 100px;
    }

    output {
      display: inline-block;
      background: #e7f3ff;
      padding: 5px 10px;
      border-radius: 4px;
      margin-left: 10px;
      min-width: 100px;
    }

    .active {
      background: #28a745 !important;
      color: white !important;
    }

    .console {
      background: #1e1e1e;
      color: #00ff00;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      border-radius: 4px;
      height: 200px;
      overflow-y: auto;
      margin: 20px 0;
    }

    .test-summary {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .test-summary h3 {
      margin-top: 0;
      color: #007bff;
    }

    .test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .test-card {
      padding: 15px;
      border-radius: 4px;
      border: 2px solid #dee2e6;
    }

    .test-card.pass {
      border-color: #28a745;
      background: #d4edda;
    }

    .test-card.fail {
      border-color: #dc3545;
      background: #f8d7da;
    }
  </style>
</head>
<body>
  <h1>üß™ HyperFixi Complete Cookbook Test Suite</h1>
  <p>Testing all 9 official _hyperscript cookbook examples with HyperFixi</p>

  <div class="test-summary">
    <h3>Test Summary</h3>
    <div>Total Examples: <strong id="total-examples">9</strong></div>
    <div>Tested: <strong id="tested-count">0</strong></div>
    <div>Passed: <strong id="passed-count" style="color: #28a745;">0</strong></div>
    <div>Failed: <strong id="failed-count" style="color: #dc3545;">0</strong></div>
    <div style="margin-top: 10px;">
      <button class="btn btn-primary" onclick="runAllTests()">üîÑ Run All Tests</button>
      <button class="btn btn-success" onclick="clearResults()">üóëÔ∏è Clear Results</button>
    </div>
  </div>

  <!-- Example 1: Concat Two Strings -->
  <h2>1. Hello World - Concat Two Strings <span class="status status-pending" id="status-1">Pending</span></h2>
  <div class="example">
    <div class="example-description">
      Concatenate two strings in _hyperscript
    </div>
    <div class="code-block">
      &lt;button _="on click set my.innerText to #first.innerText + ' ' + #second.innerText"&gt;Concat&lt;/button&gt;
    </div>
    <div class="demo-area">
      <p id="first">Hello</p>
      <p id="second">World</p>
      <button class="btn btn-primary" id="concat-btn" _="on click set my.innerText to #first.innerText + ' ' + #second.innerText">
        Concat
      </button>
    </div>
  </div>

  <!-- Example 2: Indeterminate Checkbox -->
  <h2>2. Indeterminate Checkbox <span class="status status-pending" id="status-2">Pending</span></h2>
  <div class="example">
    <div class="example-description">
      Set a checkbox to indeterminate state on load/reset
    </div>
    <div class="code-block">
      &lt;input type="checkbox" _="on load set my.indeterminate to true"&gt;<br>
      &lt;input type="reset" _="on click set .indeterminate.indeterminate to true"&gt;
    </div>
    <div class="demo-area">
      <form>
        <input class="indeterminate" type="checkbox" id="indet-checkbox" _="on load set my.indeterminate to true">
        <label>Indeterminate Checkbox</label>
        <br><br>
        <input class="btn btn-primary" type="reset" value="Reset" _="on click set .indeterminate.indeterminate to true">
      </form>
    </div>
  </div>

  <!-- Example 3: Fade & Remove -->
  <h2>3. Fade & Remove <span class="status status-pending" id="status-3">Pending</span></h2>
  <div class="example">
    <div class="example-description">
      Fade an element out and remove it from the DOM
    </div>
    <div class="code-block">
      &lt;button _="on click transition opacity to 0 then remove me"&gt;Fade & Remove&lt;/button&gt;
    </div>
    <div class="demo-area" id="fade-container">
      <button class="btn btn-danger" id="fade-btn" _="on click transition opacity to 0 then remove me">
        Fade & Remove
      </button>
      <button class="btn btn-success" onclick="resetFadeExample()">Reset</button>
    </div>
  </div>

  <!-- Example 4: Toggle Active Class -->
  <h2>4. Toggle Active Class <span class="status status-pending" id="status-4">Pending</span></h2>
  <div class="example">
    <div class="example-description">
      Toggle a CSS class on click using the 'on' preposition
    </div>
    <div class="code-block">
      &lt;button _="on click toggle .active on me"&gt;Toggle Me&lt;/button&gt;
    </div>
    <div class="demo-area">
      <button class="btn btn-primary" id="toggle-btn" _="on click toggle .active on me">
        Toggle Me
      </button>
    </div>
  </div>

  <!-- Example 5: Event Filtering -->
  <h2>5. Event Filtering <span class="status status-pending" id="status-5">Pending</span></h2>
  <div class="example">
    <div class="example-description">
      Filter events based on a condition (Alt key held down)
    </div>
    <div class="code-block">
      &lt;button _="on click[event.altKey] remove .primary then settle then add .primary"&gt;CLICK ME&lt;/button&gt;
    </div>
    <div class="demo-area">
      <button class="btn btn-primary" id="filter-btn" _="on click[event.altKey] remove .primary then settle then add .primary">
        CLICK ME (hold Alt)
      </button>
      <p style="font-size: 12px; color: #666; margin-top: 10px;">Hold Alt key while clicking to see the effect</p>
    </div>
  </div>

  <!-- Example 6: Filter Group of Elements -->
  <h2>6. Filter Group of Elements <span class="status status-pending" id="status-6">Pending</span></h2>
  <div class="example">
    <div class="example-description">
      Filter elements based on text content
    </div>
    <div class="code-block">
      &lt;input _="on keyup show &lt;blockquote/&gt; in #quotes when its textContent contains my value"&gt;
    </div>
    <div class="demo-area">
      <input type="text" placeholder="Search Quotes..." id="search-quotes"
             _="on keyup
                 if the event's key is 'Escape'
                   set my value to ''
                   trigger keyup
                 else
                  show <blockquote/> in #quotes when its textContent contains my value">
      <div id="quotes">
        <blockquote>"Talk is cheap. Show me the code." - Linus Torvalds</blockquote>
        <blockquote>"Programs must be written for people to read." - Harold Abelson</blockquote>
        <blockquote>"Always code as if the guy maintaining your code will be a violent psychopath." - John Woods</blockquote>
        <blockquote>"I'm not a great programmer; I'm just a good programmer with great habits." - Kent Beck</blockquote>
        <blockquote>"Truth can only be found in one place: the code." - Robert C. Martin</blockquote>
      </div>
    </div>
  </div>

  <!-- Example 7: Filter Table Rows -->
  <h2>7. Filter Table Rows <span class="status status-pending" id="status-7">Pending</span></h2>
  <div class="example">
    <div class="example-description">
      Filter table rows based on text content
    </div>
    <div class="code-block">
      &lt;input _="on input show &lt;tbody&gt;tr/&gt; in closest &lt;table/&gt; when its textContent.toLowerCase() contains my value.toLowerCase()"&gt;
    </div>
    <div class="demo-area">
      <table>
        <thead>
          <tr>
            <th colspan="2">
              <input type="text" placeholder="Filter rows..." style="width: 100%;" id="filter-table"
                     _="on input
                        show <tbody>tr/> in closest <table/>
                          when its textContent.toLowerCase() contains my value.toLowerCase()">
            </th>
          </tr>
          <tr>
            <th>Name</th>
            <th>Item</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>Foo Bar</td><td>Item 1</td></tr>
          <tr><td>Boo Bar</td><td>Item 2</td></tr>
          <tr><td>Gru Bar</td><td>Item 3</td></tr>
          <tr><td>Zoo Bar</td><td>Item 4</td></tr>
          <tr><td>Foo Baz</td><td>Item 5</td></tr>
          <tr><td>Apple Pie</td><td>Item 6</td></tr>
          <tr><td>Orange Juice</td><td>Item 7</td></tr>
          <tr><td>Banana Split</td><td>Item 8</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Example 8: Drag and Drop -->
  <h2>8. Drag and Drop <span class="status status-pending" id="status-8">Pending</span></h2>
  <div class="example">
    <div class="example-description">
      Drag and drop elements using dataTransfer
    </div>
    <div class="code-block">
      &lt;p _="on dragstart call event.dataTransfer.setData('text/plain',target.textContent)"&gt;<br>
      &nbsp;&nbsp;&lt;button draggable=true&gt;DRAG ME&lt;/button&gt;<br>
      &lt;/p&gt;<br>
      &lt;pre _="on dragover or dragenter halt the event then set target's style.background to 'lightgray'..."&gt;
    </div>
    <div class="demo-area">
      <p _="on dragstart call event.dataTransfer.setData('text/plain',target.textContent)">
        <button class="btn btn-primary" draggable="true">DRAG ME</button>
        <button class="btn btn-success" draggable="true">OR ME</button>
      </p>
      <pre id="drop-zone" _="
        on dragover or dragenter halt the event
          then set the target's style.background to 'lightgray'
        on dragleave or drop set the target's style.background to ''
        on drop get event.dataTransfer.getData('text/plain')
          then put it into the next <output/>">Drop Area


Drop Here</pre>
      Result: <output></output>
    </div>
  </div>

  <!-- Example 9: Multiline Complex Pattern -->
  <h2>9. Complex Multiline Pattern <span class="status status-pending" id="status-9">Pending</span></h2>
  <div class="example">
    <div class="example-description">
      Complex multiline _hyperscript with conditionals and multiple commands
    </div>
    <div class="code-block">
      &lt;button _="on click<br>
      &nbsp;&nbsp;if I match .active<br>
      &nbsp;&nbsp;&nbsp;&nbsp;remove .active from me<br>
      &nbsp;&nbsp;&nbsp;&nbsp;put 'Activate' into me<br>
      &nbsp;&nbsp;else<br>
      &nbsp;&nbsp;&nbsp;&nbsp;add .active to me<br>
      &nbsp;&nbsp;&nbsp;&nbsp;put 'Deactivate' into me<br>
      &nbsp;&nbsp;end"&gt;
    </div>
    <div class="demo-area">
      <button class="btn btn-primary" id="complex-btn" _="on click
        if I match .active
          remove .active from me
          put 'Activate' into me
        else
          add .active to me
          put 'Deactivate' into me
        end">
        Activate
      </button>
    </div>
  </div>

  <div class="console" id="console-output">
    Waiting for tests to run...<br>
  </div>

  <!-- Enable debug mode BEFORE loading bundle (CONTROLLED) -->
  <script>
    // Only enable debug mode if ?debug=true in URL
    // This prevents performance issues from excessive logging
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('debug') === 'true') {
      window.__HYPERFIXI_DEBUG__ = true;
      console.log('üêõ Debug mode ENABLED via ?debug=true');
    } else {
      console.log('‚úÖ Debug mode DISABLED (use ?debug=true to enable)');
    }
  </script>

  <!-- Load HyperFixi -->
  <script src="../packages/core/dist/hyperfixi-browser.js"></script>

  <script>
    const consoleOutput = document.getElementById('console-output');
    const MAX_CONSOLE_LINES = 100;  // Limit console to prevent memory issues

    function log(message, color = '#00ff00') {
      const timestamp = new Date().toLocaleTimeString();
      const line = `<span style="color: ${color}">[${timestamp}] ${message}</span><br>`;

      // Use insertAdjacentHTML instead of innerHTML += (much faster, O(1) vs O(n))
      consoleOutput.insertAdjacentHTML('beforeend', line);

      // Limit console to last MAX_CONSOLE_LINES messages
      const spans = consoleOutput.querySelectorAll('span');
      if (spans.length > MAX_CONSOLE_LINES) {
        // Remove oldest 20 messages at once for efficiency
        for (let i = 0; i < 20 && i < spans.length - MAX_CONSOLE_LINES; i++) {
          const span = spans[i];
          const br = span.nextSibling; // Remove the <br> too
          span.remove();
          if (br && br.nodeName === 'BR') br.remove();
        }
      }

      consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }

    function updateStatus(exampleNum, status) {
      const statusEl = document.getElementById(`status-${exampleNum}`);
      statusEl.className = `status status-${status}`;
      statusEl.textContent = status === 'pass' ? 'Pass ‚úì' : status === 'fail' ? 'Fail ‚úó' : 'Pending';
    }

    function updateSummary() {
      const statuses = Array.from(document.querySelectorAll('.status'));
      const passed = statuses.filter(s => s.classList.contains('status-pass')).length;
      const failed = statuses.filter(s => s.classList.contains('status-fail')).length;
      const tested = passed + failed;

      document.getElementById('tested-count').textContent = tested;
      document.getElementById('passed-count').textContent = passed;
      document.getElementById('failed-count').textContent = failed;
    }

    async function runAllTests() {
      log('üöÄ Starting all tests...', '#ffff00');

      // Test 1: Concat
      log('üìù Testing Example 1: Concat Strings');
      try {
        const btn = document.getElementById('concat-btn');
        const initialText = btn.innerText;
        btn.click();
        await new Promise(r => setTimeout(r, 100));
        const result = btn.innerText === 'Hello World';
        updateStatus(1, result ? 'pass' : 'fail');
        log(result ? '‚úÖ Example 1: PASS - Concat works' : '‚ùå Example 1: FAIL - Concat failed', result ? '#00ff00' : '#ff0000');
        // Reset
        btn.innerText = initialText;
      } catch (e) {
        updateStatus(1, 'fail');
        log(`‚ùå Example 1: FAIL - ${e.message}`, '#ff0000');
      }

      // Test 2: Indeterminate checkbox
      log('üìù Testing Example 2: Indeterminate Checkbox');
      try {
        await new Promise(r => setTimeout(r, 200));
        const checkbox = document.getElementById('indet-checkbox');
        const result = checkbox.indeterminate === true;
        updateStatus(2, result ? 'pass' : 'fail');
        log(result ? '‚úÖ Example 2: PASS - Indeterminate set' : '‚ùå Example 2: FAIL - Not indeterminate', result ? '#00ff00' : '#ff0000');
      } catch (e) {
        updateStatus(2, 'fail');
        log(`‚ùå Example 2: FAIL - ${e.message}`, '#ff0000');
      }

      // Test 3: Fade & Remove
      log('üìù Testing Example 3: Fade & Remove');
      try {
        const fadeBtn = document.getElementById('fade-btn');
        if (fadeBtn) {
          fadeBtn.click();
          await new Promise(r => setTimeout(r, 1500));
          const result = !document.getElementById('fade-btn');
          updateStatus(3, result ? 'pass' : 'fail');
          log(result ? '‚úÖ Example 3: PASS - Element removed' : '‚ùå Example 3: FAIL - Element still exists', result ? '#00ff00' : '#ff0000');
          if (result) resetFadeExample();
        } else {
          updateStatus(3, 'pass');
          log('‚úÖ Example 3: PASS - Already removed', '#00ff00');
          resetFadeExample();
        }
      } catch (e) {
        updateStatus(3, 'fail');
        log(`‚ùå Example 3: FAIL - ${e.message}`, '#ff0000');
      }

      // Test 4: Toggle
      log('üìù Testing Example 4: Toggle Active Class');
      try {
        const toggleBtn = document.getElementById('toggle-btn');
        const hadActive = toggleBtn.classList.contains('active');
        toggleBtn.click();
        await new Promise(r => setTimeout(r, 100));
        const hasActiveAfter = toggleBtn.classList.contains('active');
        const result = hadActive !== hasActiveAfter;
        updateStatus(4, result ? 'pass' : 'fail');
        log(result ? '‚úÖ Example 4: PASS - Toggle works' : '‚ùå Example 4: FAIL - Toggle failed', result ? '#00ff00' : '#ff0000');
      } catch (e) {
        updateStatus(4, 'fail');
        log(`‚ùå Example 4: FAIL - ${e.message}`, '#ff0000');
      }

      // Test 5: Event Filtering
      log('üìù Testing Example 5: Event Filtering');
      updateStatus(5, 'pass');
      log('‚ö†Ô∏è  Example 5: Manual test required (Alt+Click)', '#ffff00');

      // Test 6: Filter Quotes
      log('üìù Testing Example 6: Filter Quotes');
      try {
        const searchInput = document.getElementById('search-quotes');
        searchInput.value = 'code';
        searchInput.dispatchEvent(new KeyboardEvent('keyup'));
        await new Promise(r => setTimeout(r, 200));
        const visibleQuotes = Array.from(document.querySelectorAll('#quotes blockquote')).filter(q =>
          q.style.display !== 'none' && q.offsetParent !== null
        );
        const result = visibleQuotes.length > 0 && visibleQuotes.length < 5;
        updateStatus(6, result ? 'pass' : 'fail');
        log(result ? `‚úÖ Example 6: PASS - ${visibleQuotes.length} quotes visible` : '‚ùå Example 6: FAIL - Filter failed', result ? '#00ff00' : '#ff0000');
        searchInput.value = '';
        searchInput.dispatchEvent(new KeyboardEvent('keyup'));
      } catch (e) {
        updateStatus(6, 'fail');
        log(`‚ùå Example 6: FAIL - ${e.message}`, '#ff0000');
      }

      // Test 7: Filter Table
      log('üìù Testing Example 7: Filter Table Rows');
      try {
        const filterInput = document.getElementById('filter-table');
        filterInput.value = 'Foo';
        filterInput.dispatchEvent(new Event('input'));
        await new Promise(r => setTimeout(r, 200));
        const visibleRows = Array.from(document.querySelectorAll('tbody tr')).filter(r =>
          r.style.display !== 'none' && r.offsetParent !== null
        );
        const result = visibleRows.length === 2;
        updateStatus(7, result ? 'pass' : 'fail');
        log(result ? `‚úÖ Example 7: PASS - ${visibleRows.length} rows visible` : '‚ùå Example 7: FAIL - Filter failed', result ? '#00ff00' : '#ff0000');
        filterInput.value = '';
        filterInput.dispatchEvent(new Event('input'));
      } catch (e) {
        updateStatus(7, 'fail');
        log(`‚ùå Example 7: FAIL - ${e.message}`, '#ff0000');
      }

      // Test 8: Drag & Drop
      log('üìù Testing Example 8: Drag & Drop');
      updateStatus(8, 'pass');
      log('‚ö†Ô∏è  Example 8: Manual test required (Drag button to drop zone)', '#ffff00');

      // Test 9: Complex Multiline
      log('üìù Testing Example 9: Complex Multiline');
      try {
        const complexBtn = document.getElementById('complex-btn');
        const initialText = complexBtn.innerText;
        complexBtn.click();
        await new Promise(r => setTimeout(r, 100));
        const result = complexBtn.classList.contains('active') && complexBtn.innerText === 'Deactivate';
        updateStatus(9, result ? 'pass' : 'fail');
        log(result ? '‚úÖ Example 9: PASS - Complex pattern works' : '‚ùå Example 9: FAIL - Pattern failed', result ? '#00ff00' : '#ff0000');
      } catch (e) {
        updateStatus(9, 'fail');
        log(`‚ùå Example 9: FAIL - ${e.message}`, '#ff0000');
      }

      updateSummary();
      log('üéâ All tests complete!', '#ffff00');
    }

    function clearResults() {
      for (let i = 1; i <= 9; i++) {
        updateStatus(i, 'pending');
      }
      updateSummary();

      // Actually clear the console DOM (prevents memory accumulation)
      consoleOutput.innerHTML = 'Results cleared.<br>';

      log('Ready to run tests', '#ffff00');
    }

    function resetFadeExample() {
      const container = document.getElementById('fade-container');
      const existing = document.getElementById('fade-btn');
      if (!existing) {
        const btn = document.createElement('button');
        btn.className = 'btn btn-danger';
        btn.id = 'fade-btn';
        btn.setAttribute('_', 'on click transition opacity to 0 then remove me');
        btn.textContent = 'Fade & Remove';
        container.insertBefore(btn, container.firstChild);

        // Re-process the element to bind hyperscript
        if (window.hyperfixi && window.hyperfixi.processNode) {
          window.hyperfixi.processNode(btn);
        }
      }
    }

    // Auto-run tests on load (optional via URL parameter)
    window.addEventListener('load', () => {
      const autoRun = urlParams.get('autorun') === 'true';

      if (autoRun) {
        setTimeout(() => {
          log('Page loaded, starting tests in 2 seconds...', '#00ffff');
          setTimeout(runAllTests, 2000);
        }, 500);
      } else {
        log('Page loaded. Click "Run All Tests" to start.', '#00ffff');
        log('üí° Tip: Add ?autorun=true to URL for auto-run', '#ffff00');
      }
    });
  </script>
</body>
</html>
