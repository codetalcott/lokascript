<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Minimal Crash Test - Incremental Attribute Loading</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #333; }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-section.enabled {
      border-left: 4px solid #4CAF50;
    }
    .test-section.disabled {
      opacity: 0.5;
      border-left: 4px solid #ccc;
    }
    .btn {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      border: 2px solid #333;
      background: #fff;
      border-radius: 4px;
      font-size: 14px;
    }
    .btn.active {
      background: #4CAF50;
      color: white;
      border-color: #4CAF50;
    }
    #console {
      margin-top: 20px;
      padding: 15px;
      background: #000;
      color: #0f0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      border-radius: 4px;
    }
    .controls {
      position: sticky;
      top: 0;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      z-index: 1000;
    }
    input[type="number"] {
      width: 60px;
      padding: 5px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>üîç Minimal Crash Test - Incremental Attribute Loading</h1>

  <div class="controls">
    <label>
      Enable tests up to #<input type="number" id="max-test" value="0" min="0" max="11">
    </label>
    <button class="btn" onclick="reloadPage()">Reload with Selection</button>
    <button class="btn" onclick="enableAll()">Enable All Tests</button>
    <button class="btn" onclick="clearConsole()">Clear Console</button>
  </div>

  <div id="console"></div>

  <div id="tests-container">
    <!-- Tests will be dynamically added here -->
  </div>

  <script>
    // Enable debug mode
    window.__HYPERFIXI_DEBUG__ = true;

    // Capture all errors
    window.addEventListener('error', (event) => {
      log('‚ùå Global error: ' + event.error?.message, '#ff0000');
      console.error('‚ùå Global error:', event.error);
    });

    window.addEventListener('unhandledrejection', (event) => {
      log('‚ùå Unhandled promise rejection: ' + event.reason, '#ff0000');
      console.error('‚ùå Unhandled promise rejection:', event.reason);
    });

    const consoleEl = document.getElementById('console');
    function log(message, color = '#00ff00') {
      const timestamp = new Date().toLocaleTimeString();
      consoleEl.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span><br>`;
      consoleEl.scrollTop = consoleEl.scrollHeight;
    }

    function clearConsole() {
      consoleEl.innerHTML = '';
    }

    function reloadPage() {
      const maxTest = document.getElementById('max-test').value;
      window.location.href = `?max=${maxTest}`;
    }

    function enableAll() {
      window.location.href = '?max=11';
    }

    // Test definitions - all 11 patterns from full-cookbook-test.html
    const tests = [
      {
        id: 1,
        name: 'String Concatenation',
        html: `
          <p id="first">Hello</p>
          <p id="second">World</p>
          <button class="btn" _="on click set my.innerText to #first.innerText + ' ' + #second.innerText">
            Concat Strings
          </button>
          <p>Result: <span id="result1"></span></p>
        `
      },
      {
        id: 2,
        name: 'Indeterminate Checkbox (on load)',
        html: `
          <input type="checkbox" class="indeterminate" _="on load set my.indeterminate to true">
          Indeterminate state
        `
      },
      {
        id: 3,
        name: 'Set Indeterminate on Click',
        html: `
          <input type="checkbox" class="indeterminate" id="check3">
          <button class="btn" _="on click set .indeterminate.indeterminate to true">
            Make Indeterminate
          </button>
        `
      },
      {
        id: 4,
        name: 'Transition & Remove',
        html: `
          <button class="btn" id="fade-btn" _="on click transition opacity to 0 then remove me">
            Fade & Remove
          </button>
        `
      },
      {
        id: 5,
        name: 'Toggle Class',
        html: `
          <button class="btn" _="on click toggle .active on me">
            Toggle Active
          </button>
        `
      },
      {
        id: 6,
        name: 'Settle Command',
        html: `
          <button class="btn primary" _="on click[event.altKey] remove .primary then settle then add .primary">
            Alt+Click to Settle
          </button>
        `
      },
      {
        id: 7,
        name: 'Keyup with If/Else & Trigger',
        html: `
          <input type="text" class="form-control" placeholder="Search quotes (ESC to clear)"
            _="on keyup
                if the event's key is 'Escape'
                  set my value to ''
                  trigger keyup
                else
                 show <blockquote/> in #quotes when its textContent contains my value">
          <div id="quotes">
            <blockquote>To be or not to be</blockquote>
            <blockquote>All the world's a stage</blockquote>
          </div>
        `
      },
      {
        id: 8,
        name: 'Table Filtering (show...when)',
        html: `
          <input type="text" class="form-control" placeholder="Filter table"
            _="on input
               show <tbody>tr/> in closest <table/>
                 when its textContent.toLowerCase() contains my value.toLowerCase()">
          <table>
            <tbody>
              <tr><td>Apple</td></tr>
              <tr><td>Banana</td></tr>
              <tr><td>Cherry</td></tr>
            </tbody>
          </table>
        `
      },
      {
        id: 9,
        name: 'Drag Start',
        html: `
          <div class="draggable" draggable="true"
            _="on dragstart call event.dataTransfer.setData('text/plain',target.textContent)">
            Drag Me
          </div>
        `
      },
      {
        id: 10,
        name: 'Drag & Drop (Multiple Events)',
        html: `
          <div class="drop-zone" style="border: 2px dashed #ccc; padding: 20px;"
            _="on dragover or dragenter halt the event then set the target's style.background to 'lightgray'
               on dragleave or drop set the target's style.background to ''
               on drop get event.dataTransfer.getData('text/plain') then put it into the next <output/>">
            Drop Here
          </div>
          <output></output>
        `
      },
      {
        id: 11,
        name: 'Complex If/Else with Match',
        html: `
          <button class="btn"
            _="on click
               if I match .active
                 remove .active from me
                 put 'Activate' into me
               else
                 add .active to me
                 put 'Deactivate' into me
               end">
            Activate
          </button>
        `
      }
    ];

    // Get max test from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const maxTestParam = urlParams.get('max');
    const maxTest = maxTestParam ? parseInt(maxTestParam) : 0;

    log(`üîß Loading tests up to #${maxTest}`, '#00ffff');
    log(`üìä Debug mode: ${window.__HYPERFIXI_DEBUG__ ? 'ENABLED' : 'DISABLED'}`, '#ffff00');

    // Render all tests, but only enable attributes for tests <= maxTest
    const container = document.getElementById('tests-container');
    tests.forEach(test => {
      const section = document.createElement('div');
      section.className = `test-section ${test.id <= maxTest ? 'enabled' : 'disabled'}`;

      const header = document.createElement('h3');
      header.textContent = `Test ${test.id}: ${test.name} ${test.id <= maxTest ? '‚úÖ' : '‚è∏Ô∏è'}`;
      section.appendChild(header);

      const content = document.createElement('div');

      if (test.id <= maxTest) {
        // Enabled: Render HTML with _hyperscript attributes
        content.innerHTML = test.html;
        log(`‚úÖ Enabled Test ${test.id}: ${test.name}`, '#00ff00');
      } else {
        // Disabled: Render HTML but strip _hyperscript attributes
        const strippedHtml = test.html.replace(/_="[^"]*"/g, '');
        content.innerHTML = strippedHtml;
        log(`‚è∏Ô∏è  Disabled Test ${test.id}: ${test.name}`, '#888888');
      }

      section.appendChild(content);
      container.appendChild(section);
    });

    log(`‚úÖ Page rendered. Waiting for HyperFixi bundle...`, '#00ffff');
  </script>

  <!-- Load HyperFixi bundle AFTER test definitions -->
  <script src="../packages/core/dist/hyperfixi-browser.js"></script>

  <script>
    log(`‚úÖ HyperFixi bundle loaded`, '#00ff00');
    log(`üöÄ processNode() should be processing ${maxTest} test(s)...`, '#ffff00');

    // Set max-test input value
    document.getElementById('max-test').value = maxTest;

    // Wait a bit and check if page is still alive
    setTimeout(() => {
      log(`‚úÖ Page still alive after 2 seconds!`, '#00ff00');
      log(`üéâ Tests 1-${maxTest} did NOT crash the browser`, '#00ff00');
    }, 2000);
  </script>
</body>
</html>
