<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>HyperFixi vs _hyperscript Test Runner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Test Navigation -->
    <script src="/test-nav.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mocha/10.2.0/mocha.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .header {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin: 10px 0;
        }
        .stat {
            padding: 10px;
            border-radius: 4px;
            background: white;
            border: 2px solid #ddd;
        }
        .stat.passing {
            border-color: #28a745;
            color: #28a745;
        }
        .stat.failing {
            border-color: #dc3545;
            color: #dc3545;
        }
        .progress {
            margin: 10px 0;
        }
        .progress-bar {
            background: #e9ecef;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            height: 100%;
            transition: width 0.3s ease;
        }
        #test-controls {
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .category-toggle {
            margin: 5px;
            padding: 5px 10px;
            font-size: 12px;
        }
        #work-area {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ HyperFixi vs _hyperscript Test Runner</h1>
        <p>Running official _hyperscript tests against HyperFixi implementation</p>
        
        <div class="stats">
            <div class="stat passing">
                <strong id="pass-count">0</strong> Passing
            </div>
            <div class="stat failing">
                <strong id="fail-count">0</strong> Failing
            </div>
            <div class="stat">
                <strong id="total-count">0</strong> Total
            </div>
            <div class="stat">
                <strong id="completion-rate">0%</strong> Complete
            </div>
        </div>
        
        <div class="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div id="test-controls">
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="runExpressionTests()">Expression Tests</button>
        <button onclick="runCoreTests()">Core Tests</button>
        <button onclick="runCommandTests()">Command Tests</button>
        <button onclick="stopTests()" id="stop-btn" disabled>Stop Tests</button>
        
        <br><br>
        
        <label>
            <input type="checkbox" id="show-passing" checked> Show Passing Tests
        </label>
        <label>
            <input type="checkbox" id="show-failing" checked> Show Failing Tests
        </label>
        <label>
            <input type="checkbox" id="stop-on-failure"> Stop on First Failure
        </label>
    </div>

    <!-- Test Categories -->
    <div id="category-controls">
        <h3>Test Categories</h3>
        <button class="category-toggle" onclick="toggleCategory('expressions')">Expressions</button>
        <button class="category-toggle" onclick="toggleCategory('commands')">Commands</button>
        <button class="category-toggle" onclick="toggleCategory('features')">Features</button>
        <button class="category-toggle" onclick="toggleCategory('core')">Core</button>
    </div>

    <!-- Hidden work area for DOM tests -->
    <div id="work-area"></div>

    <!-- Mocha test results -->
    <div id="mocha"></div>

    <!-- Load dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.3.10/chai.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/10.2.0/mocha.min.js"></script>
    
    <!-- Load HyperFixi -->
    <script src="/dist/hyperfixi-browser.js"></script>

    <!-- Load comprehensive tests -->
    <script type="module" id="comprehensive-tests-loader">
        import { loadExpressionTests, loadCommandTests, loadCoreTests, loadFeatureTests } from './comprehensive-tests.js';
        window.loadExpressionTests = loadExpressionTests;
        window.loadCommandTests = loadCommandTests;
        window.loadCoreTests = loadCoreTests;
        window.loadFeatureTests = loadFeatureTests;
    </script>

    <!-- Load our test adapter -->
    <script>
        // Create test adapter using HyperFixi browser bundle
        window.evalHyperScript = async function(src, ctx) {
            return await hyperfixi.evalHyperScript(src, ctx);
        };

        // Test utilities that tests expect
        window.make = function(htmlStr) {
            const div = document.createElement('div');
            div.innerHTML = htmlStr;
            const element = div.firstElementChild;
            const workArea = document.getElementById('work-area');
            if (workArea && element) {
                workArea.appendChild(element);
            }
            return element;
        };

        window.clearWorkArea = function() {
            const workArea = document.getElementById('work-area');
            if (workArea) {
                workArea.innerHTML = '';
            }
        };

        window.byId = function(id) {
            return document.getElementById(id);
        };

        window.getParseErrorFor = function(src, ctx) {
            try {
                hyperfixi.compile(src);
                return '';
            } catch (e) {
                return e.message || String(e);
            }
        };

        // Set up Mocha
        mocha.setup('bdd');
        
        // Set up Chai
        window.should = chai.should();
        window.assert = chai.assert;
        
        // Track test results
        let testResults = {
            passed: 0,
            failed: 0,
            total: 0
        };

        // Update UI stats
        function updateStats() {
            document.getElementById('pass-count').textContent = testResults.passed;
            document.getElementById('fail-count').textContent = testResults.failed;
            document.getElementById('total-count').textContent = testResults.total;
            
            const completion = testResults.total > 0 
                ? Math.round((testResults.passed / testResults.total) * 100) 
                : 0;
            document.getElementById('completion-rate').textContent = completion + '%';
            document.getElementById('progress-fill').style.width = completion + '%';
        }

        // We'll attach event listeners to the runner after mocha.run() is called

        // Test running functions
        window.runAllTests = function() {
            console.log('üöÄ Starting comprehensive HyperFixi test suite...');
            document.getElementById('stop-btn').disabled = false;

            // Reset counters
            testResults = { passed: 0, failed: 0, total: 0 };
            updateStats();

            // Load all test categories
            setTimeout(() => {
                if (window.loadExpressionTests) {
                    window.loadExpressionTests();
                }
                if (window.loadCoreTests) {
                    window.loadCoreTests();
                }
                if (window.loadCommandTests) {
                    window.loadCommandTests();
                }
                if (window.loadFeatureTests) {
                    window.loadFeatureTests();
                }

                // Run all loaded tests
                setTimeout(() => {
                    console.log('üèÉ Running all registered tests...');
                    const runner = mocha.run();
                    setupRunnerEvents(runner);
                }, 200);
            }, 100);
        };

        window.runExpressionTests = function() {
            console.log('üîç Running expression tests only...');

            // Reset counters
            testResults = { passed: 0, failed: 0, total: 0 };
            updateStats();

            setTimeout(() => {
                if (window.loadExpressionTests) {
                    window.loadExpressionTests();
                }

                setTimeout(() => {
                    const runner = mocha.run();
                    setupRunnerEvents(runner);
                }, 200);
            }, 100);
        };

        window.runCommandTests = function() {
            console.log('‚öôÔ∏è Running command tests only...');

            // Reset counters
            testResults = { passed: 0, failed: 0, total: 0 };
            updateStats();

            setTimeout(() => {
                if (window.loadCommandTests) {
                    window.loadCommandTests();
                }

                setTimeout(() => {
                    const runner = mocha.run();
                    setupRunnerEvents(runner);
                }, 200);
            }, 100);
        };

        window.runCoreTests = function() {
            console.log('üèóÔ∏è Running core tests only...');

            // Reset counters
            testResults = { passed: 0, failed: 0, total: 0 };
            updateStats();

            setTimeout(() => {
                if (window.loadCoreTests) {
                    window.loadCoreTests();
                }

                setTimeout(() => {
                    const runner = mocha.run();
                    setupRunnerEvents(runner);
                }, 200);
            }, 100);
        };

        window.stopTests = function() {
            console.log('‚èπÔ∏è Stopping tests...');
            document.getElementById('stop-btn').disabled = true;
        };

        // Setup event listeners for a Mocha runner
        function setupRunnerEvents(runner) {
            runner.on('pass', function(test) {
                testResults.passed++;
                testResults.total++;
                updateStats();
            });

            runner.on('fail', function(test, err) {
                testResults.failed++;
                testResults.total++;
                updateStats();
                console.error(`‚ùå Test failed: ${test.title}`, err.message);

                if (document.getElementById('stop-on-failure')?.checked) {
                    runner.abort();
                }
            });

            runner.on('end', function() {
                console.log('‚úÖ Test run completed!');
                console.log(`Final results: ${testResults.passed}/${testResults.total} passed`);
                document.getElementById('stop-btn').disabled = true;
            });
        }

        // Make functions available globally
        window.updateStats = updateStats;
        window.testResults = testResults;
        
        console.log('‚úÖ Test runner initialized');
    </script>
</body>
</html>