// HyperFixi: Minimized production version
(function(){'use strict';if(typeof _hyperscript==='undefined'){console.error('❌ _hyperscript not found');return}_hyperscript.addCommand('fetch',function(parser,runtime,tokens){let url=parser.parseElementExpression();if(!url)parser.raiseParseError(tokens,"Expected URL after 'fetch'");let command={url:url,placement:null,target:null,options:{}};if(tokens.matchToken('with')){command=parseExtendedSyntax(parser,runtime,tokens,command)}else{command=parseShorthandSyntax(parser,runtime,tokens,command)}return{args:[command],execute:function(ctx){return executeCommand.call(this,ctx,command,runtime)}}});function parseShorthandSyntax(parser,runtime,tokens,command){tokens.matchToken('and');if(tokens.matchToken('replace')){command.placement='replace';command.target=parser.parseElementExpression()}else if(tokens.matchToken('put')){if(!tokens.matchToken('into'))parser.raiseParseError(tokens,"Expected 'into' after 'put'");command.placement='put into';command.target=parser.parseElementExpression()}else if(tokens.matchToken('append')){if(!tokens.matchToken('to'))parser.raiseParseError(tokens,"Expected 'to' after 'append'");command.placement='append to';command.target=parser.parseElementExpression()}else if(tokens.matchToken('prepend')){if(!tokens.matchToken('to'))parser.raiseParseError(tokens,"Expected 'to' after 'prepend'");command.placement='prepend to';command.target=parser.parseElementExpression()}return command}function parseExtendedSyntax(parser,runtime,tokens,command){do{let optionName=null;if(tokens.matchToken('method'))optionName='method';else if(tokens.matchToken('body'))optionName='body';else if(tokens.matchToken('headers'))optionName='headers';else if(tokens.matchToken('target'))optionName='target';else if(tokens.matchToken('placement'))optionName='placement';else parser.raiseParseError(tokens,"Expected option name");if(!tokens.matchToken(':'))parser.raiseParseError(tokens,"Expected ':' after option name");let optionValue=parser.parseElementExpression();if(optionName==='target')command.target=optionValue;else if(optionName==='placement')command.placement=optionValue;else command.options[optionName]=optionValue}while(tokens.matchToken(','));return command}async function executeCommand(ctx,command,runtime){let cfg=null;try{const element=ctx.me;const url=await runtime.resolve(command.url,ctx);cfg={url:url,method:'GET',headers:{},target:element,swap:'outerHTML',trigger:ctx.event};if(command.options.method)cfg.method=await runtime.resolve(command.options.method,ctx);if(command.options.body)cfg.body=await runtime.resolve(command.options.body,ctx);if(command.options.headers)cfg.headers={...cfg.headers,...await runtime.resolve(command.options.headers,ctx)};if(command.target)cfg.target=await runtime.resolve(command.target,ctx);if(command.placement){const placement=typeof command.placement==='string'?command.placement:await runtime.resolve(command.placement,ctx);switch(placement){case'replace':cfg.swap='outerHTML';break;case'put into':cfg.swap='innerHTML';break;case'append to':cfg.swap='beforeend';break;case'prepend to':cfg.swap='afterbegin';break;default:cfg.swap=placement}}const configEvent=new CustomEvent('fx:config',{detail:{cfg:cfg},bubbles:true,cancelable:true});element.dispatchEvent(configEvent);if(configEvent.defaultPrevented)return;const beforeEvent=new CustomEvent('fx:before',{detail:{cfg:cfg},bubbles:true,cancelable:true});element.dispatchEvent(beforeEvent);if(beforeEvent.defaultPrevented)return;const response=await fetch(cfg.url,{method:cfg.method,body:cfg.body,headers:cfg.headers});const text=await response.text();cfg.response=response;cfg.text=text;const afterEvent=new CustomEvent('fx:after',{detail:{cfg:cfg},bubbles:true,cancelable:true});element.dispatchEvent(afterEvent);if(afterEvent.defaultPrevented)return text;if(cfg.target&&cfg.text){switch(cfg.swap){case'outerHTML':cfg.target.outerHTML=cfg.text;break;case'innerHTML':cfg.target.innerHTML=cfg.text;break;case'beforeend':cfg.target.insertAdjacentHTML('beforeend',cfg.text);break;case'afterbegin':cfg.target.insertAdjacentHTML('afterbegin',cfg.text);break;default:if(typeof cfg.swap==='function')cfg.swap(cfg);else cfg.target.outerHTML=cfg.text}const swappedEvent=new CustomEvent('fx:swapped',{detail:{cfg:cfg},bubbles:true});try{if(document.contains(element))element.dispatchEvent(swappedEvent);else document.dispatchEvent(swappedEvent)}catch(e){document.dispatchEvent(swappedEvent)}}return text}catch(error){const errorEvent=new CustomEvent('fx:error',{detail:{error:error,cfg:cfg||{url:url},command:command},bubbles:true});if(ctx.me)ctx.me.dispatchEvent(errorEvent);const fixiErrorEvent=new CustomEvent('fixi:error',{detail:{error:error,command:command},bubbles:true});if(ctx.me)ctx.me.dispatchEvent(fixiErrorEvent);throw error}finally{if(cfg&&ctx.me){const finallyEvent=new CustomEvent('fx:finally',{detail:{cfg:cfg},bubbles:true});ctx.me.dispatchEvent(finallyEvent)}}}console.log('✅ HyperFixi loaded')})();