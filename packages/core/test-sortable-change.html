<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sortable Test 8: Change Detection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 2rem;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            margin-bottom: 1rem;
            font-size: 2rem;
        }

        .test-info {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .test-info h2 {
            color: #f5576c;
            margin-bottom: 0.5rem;
            font-size: 1.25rem;
        }

        .test-info p {
            color: #4a5568;
            line-height: 1.6;
        }

        .test-info code {
            background: #f7fafc;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #e53e3e;
            font-size: 0.875rem;
        }

        .test-container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .test-container h3 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .sortable-list {
            list-style: none;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
            min-height: 200px;
        }

        .sortable-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 6px;
            cursor: move;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            user-select: none;
        }

        .sortable-item:last-child {
            margin-bottom: 0;
        }

        .sortable-item:hover {
            box-shadow: 0 4px 8px rgba(245, 87, 108, 0.3);
        }

        .sortable-item.dragging {
            opacity: 0.5;
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(245, 87, 108, 0.4);
        }

        .item-icon {
            font-size: 1.5rem;
        }

        .status-panel {
            background: #edf2f7;
            padding: 1.5rem;
            border-radius: 6px;
            margin-top: 1rem;
            border-left: 4px solid #f5576c;
        }

        .status-panel h4 {
            color: #2d3748;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .status-item {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border-left: 3px solid #cbd5e0;
        }

        .status-item.changed {
            border-left-color: #48bb78;
            background: #f0fff4;
        }

        .status-item.no-change {
            border-left-color: #a0aec0;
            background: #fafafa;
        }

        .status-label {
            font-size: 0.75rem;
            color: #718096;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2d3748;
        }

        #console {
            background: #1a202c;
            color: #a0aec0;
            padding: 1.5rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .console-line {
            margin-bottom: 0.5rem;
        }

        .console-success {
            color: #48bb78;
        }

        .console-error {
            color: #f56565;
        }

        .console-info {
            color: #4299e1;
        }

        .console-warning {
            color: #f6ad55;
        }

        .console-time {
            color: #718096;
            margin-right: 0.5rem;
        }

        .instructions {
            background: #fef5e7;
            border-left: 4px solid #f39c12;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
            color: #7d5a0c;
        }

        .instructions strong {
            color: #7d5a0c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Phase 4.2: Change Detection</h1>

        <div class="test-info">
            <h2>What We're Testing</h2>
            <p>
                This test validates that the sortable behavior correctly detects when the order
                of items has actually changed, and only triggers the <code>sortable:change</code>
                event when a change occurred.
            </p>
            <p style="margin-top: 1rem;">
                <strong>Implementation:</strong><br>
                ‚Ä¢ Capture initial HTML before drag: <code>set initialHTML to my innerHTML</code><br>
                ‚Ä¢ After drag ends, compare: <code>if my innerHTML is not initialHTML</code><br>
                ‚Ä¢ Only trigger <code>sortable:change</code> if order actually changed
            </p>
        </div>

        <div class="test-container">
            <h3>üìù Sortable TODO List with Change Detection</h3>

            <script type="text/hyperscript">
behavior Sortable()
  on pointerdown(clientX, clientY)
    set draggedItem to event.target.closest('.sortable-item')
    if no draggedItem exit
    halt the event
    add .dragging to draggedItem
    set initialHTML to my innerHTML
    log 'üì∏ Captured initial HTML'
    trigger sortable:start
    repeat until event pointerup from document
      wait for pointermove(clientY) or pointerup from document
      set items to <.sortable-item/> in me
      set targetItem to null
      repeat for item in items
        if item is not draggedItem
          measure item's top
          set itemTop to it
          measure item's height
          set itemHeight to it
          set itemMid to itemTop + (itemHeight / 2)
          if clientY < itemMid
            set targetItem to item
            exit
          end
        end
      end
      if targetItem
        call me.insertBefore(draggedItem, targetItem)
      else
        call me.appendChild(draggedItem)
      end
      trigger sortable:move
    end
    remove .dragging from draggedItem
    trigger sortable:end
    if my innerHTML is not initialHTML
      log '‚úÖ Order CHANGED - triggering sortable:change'
      trigger sortable:change
    else
      log '‚ö†Ô∏è Order NOT changed - no sortable:change event'
    end
  end
end
            </script>

            <ul id="todo-list" class="sortable-list"
                _="install Sortable()
                   on sortable:change
                     call incrementChangeCount()
                   end
                   on sortable:end
                     call incrementDragCount()
                   end">
                <li class="sortable-item">
                    <span class="item-icon">üìù</span>
                    <span>Task One</span>
                </li>
                <li class="sortable-item">
                    <span class="item-icon">üí™</span>
                    <span>Task Two</span>
                </li>
                <li class="sortable-item">
                    <span class="item-icon">üìß</span>
                    <span>Task Three</span>
                </li>
                <li class="sortable-item">
                    <span class="item-icon">üìö</span>
                    <span>Task Four</span>
                </li>
            </ul>

            <div class="status-panel">
                <h4>üìä Drag Statistics</h4>
                <div class="status-grid">
                    <div class="status-item" id="drag-stat">
                        <div class="status-label">Total Drags</div>
                        <div class="status-value" id="drag-count">0</div>
                    </div>
                    <div class="status-item" id="change-stat">
                        <div class="status-label">Actual Changes</div>
                        <div class="status-value" id="change-count">0</div>
                    </div>
                </div>
            </div>

            <div class="instructions">
                <strong>üß™ Test Cases to Try:</strong><br>
                1. <strong>No Change:</strong> Click and release without moving - should NOT trigger change event<br>
                2. <strong>Drag Back:</strong> Drag item down then back to original position - should NOT trigger change<br>
                3. <strong>Actual Reorder:</strong> Drag item to new position - SHOULD trigger change event<br>
                4. Watch the counters above to see the difference between total drags and actual changes
            </div>
        </div>

        <div class="test-container">
            <h3>üñ•Ô∏è Console Output</h3>
            <div id="console">
                <div class="console-line console-info">
                    üí° The change detection logic compares innerHTML before and after drag
                </div>
                <div class="console-line console-info">
                    üß™ Try the test cases above to see change detection in action
                </div>
            </div>
        </div>
    </div>

    <!-- Load HyperFixi -->
    <script src="dist/hyperfixi-browser.js"></script>

    <script>
        // Console logging capture for display
        const consoleDiv = document.getElementById('console');
        const originalLog = console.log;

        let dragCount = 0;
        let changeCount = 0;

        window.incrementDragCount = function() {
            dragCount++;
            document.getElementById('drag-count').textContent = dragCount;
            updateStatStyles();
        };

        window.incrementChangeCount = function() {
            changeCount++;
            document.getElementById('change-count').textContent = changeCount;
            updateStatStyles();
        };

        function updateStatStyles() {
            const dragStat = document.getElementById('drag-stat');
            const changeStat = document.getElementById('change-stat');

            if (changeCount === 0) {
                changeStat.classList.remove('changed');
                changeStat.classList.add('no-change');
            } else {
                changeStat.classList.remove('no-change');
                changeStat.classList.add('changed');
            }

            // Highlight if some drags didn't result in changes
            if (dragCount > changeCount) {
                dragStat.classList.add('no-change');
            }
        }

        function addConsoleMessage(type, ...args) {
            const time = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = `console-line console-${type}`;

            const timeSpan = document.createElement('span');
            timeSpan.className = 'console-time';
            timeSpan.textContent = `[${time}]`;
            line.appendChild(timeSpan);

            const message = args.map(arg => {
                if (typeof arg === 'object') {
                    try {
                        return JSON.stringify(arg, null, 2);
                    } catch (e) {
                        return String(arg);
                    }
                }
                return String(arg);
            }).join(' ');

            line.appendChild(document.createTextNode(message));
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);

            // Determine message type
            const firstArg = String(args[0]);
            let type = 'info';
            if (firstArg.includes('‚úÖ') || firstArg.includes('CHANGED')) {
                type = 'success';
            } else if (firstArg.includes('‚ùå') || firstArg.includes('ERROR')) {
                type = 'error';
            } else if (firstArg.includes('‚ö†Ô∏è') || firstArg.includes('NOT changed')) {
                type = 'warning';
            }

            addConsoleMessage(type, ...args);
        };

        // Log HyperFixi initialization
        console.log('üöÄ HyperFixi loaded and ready');
        console.log('üìç Test page: test-sortable-change.html');
        console.log('üéØ Testing: Change detection (innerHTML comparison)');
        console.log('');
        console.log('üëâ Try dragging items and watch the counters!');
    </script>
</body>
</html>
