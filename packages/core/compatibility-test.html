<!DOCTYPE html>
<html>
<head>
    <title>HyperScript Compatibility Test</title>
</head>
<body>
    <div id="work-area"></div>
    
    <!-- Original _hyperscript library -->
    <script src="/dist/_hyperscript.js"></script>
    
    <!-- Our hyperfixi implementation -->
    <script src="/dist/hyperfixi-browser.js"></script>
    
    <script>
        // Setup compatibility helpers
        window.testResults = [];
        
        window.testExpression = async function(expression, context = {}) {
            try {
                // Use the correct API for both libraries
                let original, originalError;
                let ours, oursError;
                
                // Test _hyperscript
                try {
                    original = _hyperscript.evaluate(expression, context);
                } catch (err) {
                    originalError = err.message;
                }
                
                // Test hyperfixi
                try {
                    ours = await hyperfixi.evalHyperScript(expression, context);
                } catch (err) {
                    oursError = err.message;
                }
                
                // Both succeeded - compare values
                if (!originalError && !oursError) {
                    return { expression, original, ours, match: original === ours };
                }
                
                // Both failed - check if error messages are similar (compatibility)
                if (originalError && oursError) {
                    // For mixed operator errors, both should fail - that's compatible
                    const isMixedOperatorError = originalError.includes('parenthesize') || oursError.includes('parenthesize');
                    return { 
                        expression, 
                        original: `ERROR: ${originalError}`, 
                        ours: `ERROR: ${oursError}`, 
                        match: isMixedOperatorError 
                    };
                }
                
                // One succeeded, one failed - not compatible
                return { 
                    expression, 
                    original: originalError ? `ERROR: ${originalError}` : original, 
                    ours: oursError ? `ERROR: ${oursError}` : ours, 
                    match: false 
                };
                
            } catch (error) {
                return { expression, error: error.message, match: false };
            }
        };
        
        // Set up global evalHyperScript function for test compatibility
        window.evalHyperScript = hyperfixi.evalHyperScript;
        window.getParseErrorFor = function(expr) {
            try {
                hyperfixi.evalHyperScript(expr);
                return null;
            } catch (e) {
                return e.message;
            }
        };
        
        // Clear work area helper
        window.clearWorkArea = function() {
            document.getElementById('work-area').innerHTML = '';
        };
        
        // Test command execution helper
        window.testCommandExecution = async function(command, context = {}) {
            try {
                // Set up context variables globally for the command to access
                if (context) {
                    Object.assign(window, context);
                }
                
                await hyperfixi.evalHyperScript(command, context);
                
                // Return context variables that may have been set
                const result = {};
                // Copy any global variables that may have been set
                if (window.x !== undefined) result.x = window.x;
                if (window.message !== undefined) result.message = window.message;
                if (window.result !== undefined) result.result = window.result;
                if (window.myVar !== undefined) result.myVar = window.myVar;
                if (window.myValue !== undefined) result.myValue = window.myValue;
                
                return { success: true, context: result };
            } catch (error) {
                return { success: false, error: error.message };
            }
        };
        
        // Helper for context conversion - _hyperscript uses different context format
        window.testExpressionWithContext = async function(expression, context = {}) {
            try {
                // Convert our context format to _hyperscript format if needed
                let hyperschriptContext = context;
                if (context.locals) {
                    // _hyperscript expects variables in the root context
                    hyperschriptContext = { ...context, ...context.locals };
                }
                if (context.me) {
                    hyperschriptContext.me = context.me;
                }
                if (context.you) {
                    hyperschriptContext.you = context.you;
                }
                if (context.result) {
                    hyperschriptContext.it = context.result;
                }
                
                const original = _hyperscript.evaluate(expression, hyperschriptContext);
                const ours = await hyperfixi.evalHyperScript(expression, context);
                return { expression, original, ours, match: original === ours };
            } catch (error) {
                return { expression, error: error.message, match: false };
            }
        };
    </script>
</body>
</html>