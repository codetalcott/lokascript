<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sortable Test 7: Custom Events</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            margin-bottom: 1rem;
            font-size: 2rem;
        }

        .test-info {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .test-info h2 {
            color: #667eea;
            margin-bottom: 0.5rem;
            font-size: 1.25rem;
        }

        .test-info p {
            color: #4a5568;
            line-height: 1.6;
        }

        .test-info code {
            background: #f7fafc;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #e53e3e;
            font-size: 0.875rem;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .test-container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .test-container h3 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .sortable-list {
            list-style: none;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
            min-height: 200px;
        }

        .sortable-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 6px;
            cursor: move;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            user-select: none;
        }

        .sortable-item:last-child {
            margin-bottom: 0;
        }

        .sortable-item:hover {
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .sortable-item.dragging {
            opacity: 0.5;
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
        }

        .item-icon {
            font-size: 1.5rem;
        }

        #event-log {
            background: #1a202c;
            color: #a0aec0;
            padding: 1.5rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .event-line {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-left: 3px solid #4a5568;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .event-start {
            border-left-color: #4299e1;
            color: #90cdf4;
        }

        .event-move {
            border-left-color: #9f7aea;
            color: #d6bcfa;
        }

        .event-end {
            border-left-color: #48bb78;
            color: #9ae6b4;
        }

        .event-change {
            border-left-color: #f6ad55;
            color: #fbd38d;
        }

        .event-time {
            color: #718096;
            margin-right: 0.5rem;
        }

        .event-type {
            font-weight: bold;
            margin-right: 0.5rem;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .stat-card {
            background: #2d3748;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: white;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #a0aec0;
            margin-top: 0.25rem;
        }

        .stat-start { background: #2c5282; }
        .stat-move { background: #553c9a; }
        .stat-end { background: #2f855a; }
        .stat-change { background: #c05621; }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s;
            margin-top: 1rem;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéâ Phase 4.1: Custom Events</h1>

        <div class="test-info">
            <h2>What We're Testing</h2>
            <p>
                This test validates that the sortable behavior emits custom events at the correct
                lifecycle stages: <code>sortable:start</code>, <code>sortable:move</code>,
                <code>sortable:end</code>, and <code>sortable:change</code>.
            </p>
            <p style="margin-top: 1rem;">
                <strong>Events:</strong><br>
                ‚Ä¢ <code>sortable:start</code> - Fired when drag begins<br>
                ‚Ä¢ <code>sortable:move</code> - Fired during dragging (continuous)<br>
                ‚Ä¢ <code>sortable:end</code> - Fired when drag ends<br>
                ‚Ä¢ <code>sortable:change</code> - Fired only if order changed
            </p>
        </div>

        <div class="content-grid">
            <div class="test-container">
                <h3>üìù Sortable TODO List</h3>

                <script type="text/hyperscript">
behavior Sortable()
  on pointerdown(clientX, clientY)
    set draggedItem to event.target.closest('.sortable-item')
    if no draggedItem exit
    halt the event
    add .dragging to draggedItem
    trigger sortable:start
    repeat until event pointerup from document
      wait for pointermove(clientY) or pointerup from document
      set items to <.sortable-item/> in me
      set targetItem to null
      repeat for item in items
        if item is not draggedItem
          measure item's top
          set itemTop to it
          measure item's height
          set itemHeight to it
          set itemMid to itemTop + (itemHeight / 2)
          if clientY < itemMid
            set targetItem to item
            exit
          end
        end
      end
      if targetItem
        call me.insertBefore(draggedItem, targetItem)
      else
        call me.appendChild(draggedItem)
      end
      trigger sortable:move
    end
    remove .dragging from draggedItem
    trigger sortable:end
    trigger sortable:change
  end
end
                </script>

                <ul id="todo-list" class="sortable-list"
                    _="install Sortable()
                       on sortable:start
                         call logEvent('sortable:start', 'Drag started')
                       end
                       on sortable:move
                         call logEvent('sortable:move', 'Item moving')
                       end
                       on sortable:end
                         call logEvent('sortable:end', 'Drag ended')
                       end
                       on sortable:change
                         call logEvent('sortable:change', 'Order changed!')
                       end">
                    <li class="sortable-item">
                        <span class="item-icon">üìù</span>
                        <span>Buy groceries</span>
                    </li>
                    <li class="sortable-item">
                        <span class="item-icon">üí™</span>
                        <span>Go to the gym</span>
                    </li>
                    <li class="sortable-item">
                        <span class="item-icon">üìß</span>
                        <span>Reply to emails</span>
                    </li>
                    <li class="sortable-item">
                        <span class="item-icon">üìö</span>
                        <span>Read book chapter</span>
                    </li>
                </ul>

                <p style="margin-top: 1rem; color: #4a5568; font-size: 0.875rem;">
                    <strong>Try it:</strong> Drag items to see events fire in real-time
                </p>
            </div>

            <div class="test-container">
                <h3>üìä Event Monitor</h3>

                <div class="stats">
                    <div class="stat-card stat-start">
                        <div class="stat-value" id="count-start">0</div>
                        <div class="stat-label">START</div>
                    </div>
                    <div class="stat-card stat-move">
                        <div class="stat-value" id="count-move">0</div>
                        <div class="stat-label">MOVE</div>
                    </div>
                    <div class="stat-card stat-end">
                        <div class="stat-value" id="count-end">0</div>
                        <div class="stat-label">END</div>
                    </div>
                    <div class="stat-card stat-change">
                        <div class="stat-value" id="count-change">0</div>
                        <div class="stat-label">CHANGE</div>
                    </div>
                </div>

                <div id="event-log" style="margin-top: 1rem;">
                    <div class="event-line event-start">
                        <span class="event-time">[--:--:--]</span>
                        <span class="event-type">üì°</span>
                        Event log initialized - drag items to see events
                    </div>
                </div>

                <button onclick="clearEventLog()">Clear Log</button>
            </div>
        </div>
    </div>

    <!-- Load HyperFixi -->
    <script src="dist/hyperfixi-browser.js"></script>

    <script>
        // Event tracking
        const eventCounts = {
            'sortable:start': 0,
            'sortable:move': 0,
            'sortable:end': 0,
            'sortable:change': 0
        };

        window.logEvent = function(eventType, message) {
            // Update counter
            eventCounts[eventType]++;
            document.getElementById(`count-${eventType.split(':')[1]}`).textContent = eventCounts[eventType];

            // Add to log
            const eventLog = document.getElementById('event-log');
            const time = new Date().toLocaleTimeString();
            const line = document.createElement('div');

            // Determine event class
            let className = 'event-line';
            let icon = 'üì°';
            if (eventType === 'sortable:start') {
                className += ' event-start';
                icon = 'üé¨';
            } else if (eventType === 'sortable:move') {
                className += ' event-move';
                icon = 'üîÑ';
            } else if (eventType === 'sortable:end') {
                className += ' event-end';
                icon = 'üèÅ';
            } else if (eventType === 'sortable:change') {
                className += ' event-change';
                icon = '‚ú®';
            }

            line.className = className;
            line.innerHTML = `
                <span class="event-time">[${time}]</span>
                <span class="event-type">${icon} ${eventType}</span>
                ${message}
            `;

            eventLog.appendChild(line);
            eventLog.scrollTop = eventLog.scrollHeight;

            // Also log to console
            console.log(`[${eventType}]`, message);
        };

        window.clearEventLog = function() {
            // Reset counters
            Object.keys(eventCounts).forEach(key => {
                eventCounts[key] = 0;
                const counterType = key.split(':')[1];
                document.getElementById(`count-${counterType}`).textContent = '0';
            });

            // Clear log
            const eventLog = document.getElementById('event-log');
            eventLog.innerHTML = `
                <div class="event-line event-start">
                    <span class="event-time">[--:--:--]</span>
                    <span class="event-type">üì°</span>
                    Event log cleared - drag items to see events
                </div>
            `;
        };

        // Log HyperFixi initialization
        console.log('üöÄ HyperFixi loaded and ready');
        console.log('üìç Test page: test-sortable-events.html');
        console.log('üéØ Testing: Custom event lifecycle (sortable:start, :move, :end, :change)');
    </script>
</body>
</html>
