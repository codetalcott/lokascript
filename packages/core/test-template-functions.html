<!DOCTYPE html>
<html>
<head>
    <title>Template Function Calls Test</title>
</head>
<body>
    <div id="test-area">
        <template id="color-template">
            <ul>
                @repeat in colors
                    @set bg to it
                    @set fg to getContrastingColor(it) 
                    <li style="background: ${bg}; color: ${unescaped fg}">${bg}</li>
                @end
            </ul>
        </template>
        
        <div id="result"></div>
        
        <button id="render-btn">Render Template</button>
    </div>

    <script type="module">
        import { evalHyperscript } from './dist/hyperscript-fixi.mjs';
        
        // Define test function globally
        window.getContrastingColor = function(bgColor) {
            console.log('getContrastingColor called with:', bgColor);
            // Simple logic: light colors get dark text, dark colors get light text
            if (bgColor === 'red' || bgColor === 'blue' || bgColor === 'green') {
                return 'white';
            }
            return 'black';
        };
        
        // Test data
        const colors = ['red', 'green', 'blue', 'yellow'];
        
        document.getElementById('render-btn').addEventListener('click', async () => {
            try {
                console.log('=== Testing Template Function Calls ===');
                
                const template = document.getElementById('color-template');
                const result = await evalHyperscript(`render #color-template with (colors: colors)`, {
                    me: document.getElementById('result'),
                    it: null,
                    you: null,
                    result: null,
                    locals: new Map([['colors', colors]]),
                    globals: new Map([['getContrastingColor', window.getContrastingColor]])
                });
                
                console.log('Template render result:', result);
                
                // Append result to the result div
                document.getElementById('result').innerHTML = '';
                document.getElementById('result').appendChild(result);
                
            } catch (error) {
                console.error('Template function call test failed:', error);
                document.getElementById('result').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>