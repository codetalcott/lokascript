<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lazy Loading Bundle Test</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
      background: #1a1a2e;
      color: #eee;
      padding: 20px;
      margin: 0;
      line-height: 1.6;
    }
    h1 {
      color: #4ade80;
      margin-bottom: 20px;
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
    }
    .results {
      background: #16213e;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .result {
      padding: 8px 12px;
      margin: 4px 0;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .pass {
      background: rgba(74, 222, 128, 0.1);
      border-left: 3px solid #4ade80;
      color: #4ade80;
    }
    .fail {
      background: rgba(248, 113, 113, 0.1);
      border-left: 3px solid #f87171;
      color: #f87171;
    }
    .pending {
      background: rgba(251, 191, 36, 0.1);
      border-left: 3px solid #fbbf24;
      color: #fbbf24;
    }
    .info {
      background: rgba(96, 165, 250, 0.1);
      border-left: 3px solid #60a5fa;
      color: #60a5fa;
    }
    .status {
      font-weight: bold;
      min-width: 60px;
    }
    .summary {
      margin-top: 20px;
      padding: 15px;
      background: #0f3460;
      border-radius: 8px;
    }
    .summary.success { border: 2px solid #4ade80; }
    .summary.failure { border: 2px solid #f87171; }
    code {
      background: #2a2a4a;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <h1>üîÑ Lazy Loading Bundle Test</h1>
  <div class="results" id="results"></div>
  <div class="summary" id="summary"></div>

  <script src="dist/browser-lazy.lazy.global.js"></script>
  <script>
    const resultsEl = document.getElementById('results');
    const summaryEl = document.getElementById('summary');
    let passed = 0;
    let failed = 0;

    function log(msg, status = 'pass') {
      const div = document.createElement('div');
      div.className = `result ${status}`;
      const statusText = status.toUpperCase();
      div.innerHTML = `<span class="status">${statusText}</span><span>${msg}</span>`;
      resultsEl.appendChild(div);

      if (status === 'pass') passed++;
      else if (status === 'fail') failed++;
    }

    function updateSummary() {
      const total = passed + failed;
      const allPassed = failed === 0;
      summaryEl.className = `summary ${allPassed ? 'success' : 'failure'}`;
      summaryEl.innerHTML = `
        <strong>${allPassed ? '‚úÖ All tests passed!' : '‚ùå Some tests failed'}</strong><br>
        Passed: ${passed} / ${total}
      `;
    }

    async function runTests() {
      const Lazy = window.HyperFixiSemanticLazy;

      // Test 1: Global available
      if (Lazy) {
        log('<code>HyperFixiSemanticLazy</code> global is available');
      } else {
        log('<code>HyperFixiSemanticLazy</code> not found - bundle failed to load', 'fail');
        updateSummary();
        return;
      }

      // Test 2: Check API exports
      const expectedExports = ['loadLanguage', 'loadLanguages', 'canLoadLanguage', 'getLoadedLanguages', 'parse', 'tokenize'];
      for (const fn of expectedExports) {
        if (typeof Lazy[fn] === 'function') {
          log(`<code>${fn}()</code> is exported`);
        } else {
          log(`<code>${fn}()</code> is missing from exports`, 'fail');
        }
      }

      // Test 3: No languages initially registered
      const initial = Lazy.getRegisteredLanguages();
      if (initial.length === 0) {
        log(`No languages pre-registered (registry empty)`);
      } else {
        log(`Expected 0 languages, found ${initial.length}: ${initial.join(', ')}`, 'fail');
      }

      // Test 4: canLoadLanguage works
      if (Lazy.canLoadLanguage('en') && Lazy.canLoadLanguage('ja') && !Lazy.canLoadLanguage('xx')) {
        log('<code>canLoadLanguage()</code> returns correct values');
      } else {
        log('<code>canLoadLanguage()</code> returned unexpected results', 'fail');
      }

      // Test 5: Load English
      log('Loading English...', 'pending');
      const enResult = await Lazy.loadLanguage('en');
      if (enResult.loaded && !enResult.error) {
        log('English loaded successfully');
      } else {
        log(`Failed to load English: ${enResult.error || 'unknown error'}`, 'fail');
      }

      // Test 6: Parse English
      try {
        const node = Lazy.parse('toggle .active', 'en');
        if (node && node.action === 'toggle') {
          log('English parsing works: <code>toggle .active</code> ‚Üí action=toggle');
        } else {
          log(`Parse returned unexpected result: ${JSON.stringify(node)}`, 'fail');
        }
      } catch (e) {
        log(`English parse failed: ${e.message}`, 'fail');
      }

      // Test 7: Load Japanese
      log('Loading Japanese...', 'pending');
      const jaResult = await Lazy.loadLanguage('ja');
      if (jaResult.loaded && !jaResult.error) {
        log('Japanese loaded successfully');
      } else {
        log(`Failed to load Japanese: ${jaResult.error || 'unknown error'}`, 'fail');
      }

      // Test 8: Parse Japanese (SOV order: patient „Çí verb)
      try {
        const node = Lazy.parse('.active „Çí „Éà„Ç∞„É´', 'ja');
        if (node && node.action === 'toggle') {
          log('Japanese parsing works: <code>.active „Çí „Éà„Ç∞„É´</code> ‚Üí action=toggle');
        } else {
          log(`Parse returned unexpected result: ${JSON.stringify(node)}`, 'fail');
        }
      } catch (e) {
        log(`Japanese parse failed: ${e.message}`, 'fail');
      }

      // Test 9: Verify loaded languages
      const loaded = Lazy.getLoadedLanguages();
      if (loaded.includes('en') && loaded.includes('ja')) {
        log(`Loaded languages: <code>${loaded.join(', ')}</code>`, 'info');
      } else {
        log(`Expected en,ja in loaded languages, got: ${loaded.join(', ')}`, 'fail');
      }

      // Test 10: Unregistered language should throw
      try {
        Lazy.parse('alternar .active', 'es');
        log('Spanish parse should have thrown (not loaded)', 'fail');
      } catch (e) {
        if (e.message.includes('not loaded') || e.message.includes('not registered')) {
          log('Correctly threw error for unloaded Spanish');
        } else {
          log(`Unexpected error type: ${e.message}`, 'fail');
        }
      }

      // Test 11: Load multiple languages
      log('Loading Spanish and Korean...', 'pending');
      const multiResult = await Lazy.loadLanguages(['es', 'ko']);
      if (multiResult.length === 2 && multiResult.every(r => r.loaded)) {
        log('<code>loadLanguages()</code> loaded multiple languages');
      } else {
        log('loadLanguages() failed to load all languages', 'fail');
      }

      // Test 12: Spanish now works
      try {
        const node = Lazy.parse('alternar .active', 'es');
        if (node && node.action === 'toggle') {
          log('Spanish parsing works after loading: <code>alternar .active</code>');
        } else {
          log('Spanish parse returned unexpected result', 'fail');
        }
      } catch (e) {
        log(`Spanish parse failed after loading: ${e.message}`, 'fail');
      }

      // Test 13: Skip already loaded
      const skipResult = await Lazy.loadLanguage('en');
      if (!skipResult.loaded && !skipResult.error) {
        log('Correctly skipped already-loaded English');
      } else {
        log('skipIfRegistered behavior incorrect', 'fail');
      }

      log('--- Tests Complete ---', 'info');
      updateSummary();
    }

    runTests().catch(e => {
      log(`Test runner error: ${e.message}`, 'fail');
      updateSummary();
    });
  </script>
</body>
</html>
