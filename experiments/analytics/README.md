# @lokascript/analytics

Behavior analytics and instrumentation for LokaScript applications.

## Features

- **Event Tracking**: Track hyperscript compilation, execution, errors, and custom events
- **Performance Monitoring**: Measure execution times and identify bottlenecks
- **Session Management**: Track user sessions with automatic ID generation
- **Privacy Controls**: DNT support, IP anonymization, consent management
- **Real-time Subscriptions**: Subscribe to analytics events as they happen
- **Data Export**: Export analytics data as JSON or CSV
- **Alert System**: Configure alerts based on error rates or thresholds

## Installation

```bash
npm install @lokascript/analytics
```

## Browser Usage

```html
<script src="lokascript-browser.js"></script>
<script src="analytics-browser.global.js"></script>
<script>
  const analytics = await LokaScriptAnalytics.quickStartAnalytics({});
  LokaScriptAnalytics.integrateWithLokaScript(lokascript, analytics);
</script>
```

## Quick Start

```typescript
import { quickStartAnalytics, integrateWithLokaScript } from '@lokascript/analytics';

// Create analytics system with in-memory storage
const analytics = await quickStartAnalytics({
  trackingId: 'my-app',
  privacy: {
    anonymizeIPs: true,
    respectDNT: true,
  },
});

// Integrate with LokaScript runtime for automatic tracking
const cleanup = integrateWithLokaScript(lokascript, analytics);

// Analytics are now automatically tracked for all hyperscript executions!
```

## LokaScript Integration

### Runtime Integration (Recommended)

The `integrateWithLokaScript()` function automatically tracks all hyperscript command executions:

```typescript
import { createAnalyticsSystem, integrateWithLokaScript } from '@lokascript/analytics';

// Create analytics with custom storage
const analytics = createAnalyticsSystem({
  storage: myStorageBackend,
  tracker: {
    trackingId: 'my-app',
    batchSize: 100,
    batchTimeout: 5000,
  },
});

// Integrate with LokaScript
const cleanup = integrateWithLokaScript(lokascript, analytics, {
  trackTiming: true, // Track execution duration (default: true)
  includeScriptContent: false, // Include script in events (default: false for privacy)
  maxScriptLength: 500, // Max script length if included (default: 500)
});

// Later, to stop tracking:
cleanup();
```

**What gets tracked automatically:**

- Command executions (success/failure)
- Execution timing
- Element context (tag, id, classes)
- Event type that triggered execution
- Error details on failure

### Compilation Tracking (Optional)

For compilation analytics, use the `createTrackedCompile()` wrapper:

```typescript
import { createTrackedCompile } from '@lokascript/analytics';

// Wrap the compile function
const trackedCompile = createTrackedCompile(lokascript.compile, analytics);

// Use it instead of lokascript.compile
const result = trackedCompile('toggle .active on me');
```

**What gets tracked:**

- Script content (truncated for privacy)
- Compilation time
- Errors and warnings
- Metadata (complexity, features, commands used)

### Requirements

> **Important**: The `integrateWithLokaScript()` function requires the **full LokaScript runtime**.
> It is not compatible with lite/generated bundles because they use a minimal inline runtime
> without the hook system.
>
> Compatible with:
>
> - `lokascript-browser.js` (full bundle)
> - `hyperscript` API from `@lokascript/core`
> - Custom `Runtime` instances from `createRuntime()`
>
> NOT compatible with:
>
> - Lite bundles generated by `@lokascript/vite-plugin`
> - Custom bundles from `generate-inline-bundle.ts`

## Manual Tracking

You can also track events manually:

```typescript
// Track compilation
analytics.track.compilation({
  script: 'toggle .active',
  compilationTime: 5,
  commands: ['toggle'],
  errors: [],
  warnings: [],
});

// Track execution
analytics.track.execution({
  script: 'toggle .active',
  element: 'button#submit',
  event: 'click',
  executionTime: 2.5,
  success: true,
});

// Track errors
analytics.track.error(new Error('Something went wrong'), {
  commandName: 'toggle',
  element: 'button',
});

// Track custom events
analytics.track.custom('user:action', {
  action: 'form-submit',
  formId: 'contact-form',
});
```

## Querying Analytics

```typescript
// Query events
const events = await analytics.query({
  eventTypes: ['hyperscript:executed'],
  startTime: Date.now() - 3600000, // Last hour
  limit: 100,
});

// Aggregate data
const stats = await analytics.aggregate({
  eventTypes: ['hyperscript:executed'],
  aggregations: {
    totalExecutions: { type: 'count' },
    avgExecutionTime: { type: 'avg', field: 'executionTime' },
    maxExecutionTime: { type: 'max', field: 'executionTime' },
  },
});

// Get metrics
const metrics = analytics.getMetrics();
```

## Real-time Subscriptions

```typescript
// Subscribe to error events
const subId = analytics.subscribe({ eventTypes: ['hyperscript:error'] }, events => {
  console.log('New errors:', events);
});

// Unsubscribe
analytics.unsubscribe(subId);
```

## Alerts

```typescript
// Add an alert for high error rates
analytics.addAlert({
  id: 'high-error-rate',
  name: 'High Error Rate',
  condition: {
    metric: 'error_rate',
    operator: 'gt',
    threshold: 0.1, // 10% error rate
    window: 300000, // 5 minutes
  },
  actions: [
    {
      type: 'webhook',
      config: { url: 'https://my-alerts.example.com/webhook' },
    },
  ],
});

// Remove alert
analytics.removeAlert('high-error-rate');
```

## Session Management

```typescript
// Set user context
analytics.setUserId('user-123');
analytics.setTenantId('tenant-456');

// Get current session
const session = analytics.getSession();
console.log(session.id, session.startTime);
```

## Configuration

```typescript
const analytics = createAnalyticsSystem({
  storage: myStorage,
  tracker: {
    enabled: true,
    trackingId: 'my-app',
    apiEndpoint: 'https://analytics.example.com/api',
    batchSize: 50,
    batchTimeout: 5000,
    sampling: {
      enabled: true,
      rate: 0.1, // Sample 10% of events
    },
    privacy: {
      anonymizeIPs: true,
      respectDNT: true,
      cookieConsent: true,
    },
    events: {
      compilation: true,
      execution: true,
      interactions: true,
      performance: true,
      errors: true,
      customEvents: true,
    },
  },
  collector: {
    batchSize: 100,
    flushInterval: 10000,
    maxBufferSize: 10000,
    alerting: {
      enabled: true,
      checkInterval: 60000,
    },
    realtime: {
      enabled: true,
      maxSubscriptions: 100,
    },
  },
});
```

## Storage Backends

The analytics system requires a storage backend implementing the `AnalyticsStorage` interface:

```typescript
interface AnalyticsStorage {
  store(event: AnalyticsEvent): Promise<void>;
  storeBatch(events: AnalyticsEvent[]): Promise<void>;
  query(query: AnalyticsQuery): Promise<AnalyticsEvent[]>;
  aggregate(query: AggregationQuery): Promise<Record<string, number>>;
  delete(query: AnalyticsQuery): Promise<number>;
}
```

### In-Memory Storage

For quick prototyping, use `createInMemoryStorage()` with automatic cleanup:

```typescript
import { createInMemoryStorage } from '@lokascript/analytics';

const storage = createInMemoryStorage({
  maxEvents: 1000, // Max events before pruning oldest (default: 1000)
  ttlMs: 60 * 60 * 1000, // Event TTL in ms (default: 1 hour)
  cleanupIntervalMs: 60000, // Auto-cleanup interval (default: 1 minute)
});

// Manual methods
storage.stats(); // { count, oldestTimestamp, newestTimestamp }
storage.cleanup(); // Force cleanup
storage.destroy(); // Stop cleanup timer and clear data
```

The `quickStartAnalytics()` function uses this storage by default.

## API Reference

### Functions

| Function                                                | Description                                                   |
| ------------------------------------------------------- | ------------------------------------------------------------- |
| `createAnalyticsSystem(options)`                        | Create a complete analytics system with tracker and collector |
| `quickStartAnalytics(options)`                          | Quick setup with in-memory storage                            |
| `integrateWithLokaScript(runtime, analytics, options?)` | Integrate with LokaScript runtime                             |
| `createTrackedCompile(compile, analytics)`              | Wrap compile function for tracking                            |
| `createInMemoryStorage(options?)`                       | Create in-memory storage with auto-cleanup                    |
| `createExpressAnalyticsMiddleware(analytics)`           | Express.js middleware                                         |
| `createElysiaAnalyticsPlugin(analytics)`                | Elysia framework plugin                                       |

### Types

See [src/types.ts](src/types.ts) for complete type definitions.

## License

MIT
